<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>zarpuy</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6d_s6U4UYZu5g9E&libraries=places&language=fa" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --gold-primary: #D4AF37;
            --gold-secondary: #C9A961;
            --gold-dark: #B8860B;
            --gold-light: #F4E4BC;
            --black-primary: #1a1a1a;
            --black-secondary: #2c2c2c;
            --cream-bg: #FAF8F3;
            --cream-light: #F5F1E8;
            --white: #FFFFFF;
            --gray-light: #E8E5DF;
            --gray-medium: #9B9B9B;
            --gray-dark: #5A5A5A;
            --shadow-sm: 0 2px 8px rgba(26, 26, 26, 0.08);
            --shadow-md: 0 4px 16px rgba(26, 26, 26, 0.12);
            --shadow-lg: 0 8px 32px rgba(26, 26, 26, 0.16);
            --shadow-gold: 0 4px 20px rgba(212, 175, 55, 0.25);
        }

        body {
            font-family: 'Vazirmatn', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--cream-bg) 0%, var(--cream-light) 100%);
            direction: rtl;
            overflow-x: hidden;
            padding-bottom: 80px;
            padding-top: 80px;
            color: var(--black-primary);
            line-height: 1.6;
        }

        /* Header Styles */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--white) 0%, var(--cream-light) 100%);
            box-shadow: var(--shadow-md);
            border-bottom: 2px solid var(--gold-light);
            z-index: 1000;
            padding: 16px 20px 16px 12px;
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: space-between;
        }

        .header-admin-mode .store-selector,
        .header-admin-mode .city-selector,
        .header-admin-mode .address-btn,
        .header-admin-mode .menu-btn {
            display: none;
        }

        .header-admin-buttons {
            display: none;
            gap: 12px;
            flex: 1;
        }

        .header-admin-mode .header-admin-buttons {
            display: flex;
        }

        .header-admin-mode .back-btn {
            display: flex !important;
        }

        .header-admin-btn {
            flex: 1;
            padding: 0 24px;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            height: 48px;
            min-width: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        .header-admin-btn:active {
            transform: scale(0.98);
        }

        .header-admin-btn-support {
            background: linear-gradient(135deg, var(--black-primary) 0%, var(--black-secondary) 100%);
            color: var(--gold-primary);
            border: 2px solid var(--gold-primary);
            min-width: 120px;
            padding: 0 18px;
            font-size: 14px;
        }

        .header-admin-btn-support:hover {
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-secondary) 100%);
            color: var(--black-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-gold);
        }

        .header-admin-btn-products {
            background: linear-gradient(135deg, var(--black-primary) 0%, var(--black-secondary) 100%);
            color: var(--gold-primary);
            border: 2px solid var(--gold-primary);
        }

        .header-admin-btn-products:hover {
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-secondary) 100%);
            color: var(--black-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-gold);
        }

        .store-selector {
            flex: 1;
            position: relative;
        }

        .store-selector-btn {
            width: 100%;
            padding: 12px 18px;
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-secondary) 100%);
            color: var(--black-primary);
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-gold);
            letter-spacing: 0.3px;
        }
        
        .city-selector {
            flex: 0 0 auto;
            position: relative;
        }
        
        .city-selector-btn {
            padding: 12px 26px;
            background: linear-gradient(135deg, #8a96a4 0%, #858f99 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
            white-space: nowrap;
        }
        
        .city-selector-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
            background: linear-gradient(135deg, #357abd 0%, #4a90e2 100%);
        }
        
        .city-selector-btn:active {
            transform: translateY(0);
        }
        
        .city-selector-btn::after {
            content: '▼';
            font-size: 9px;
            margin-right: 6px;
        }

        .store-selector-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(212, 175, 55, 0.35);
            background: linear-gradient(135deg, var(--gold-secondary) 0%, var(--gold-primary) 100%);
        }

        .store-selector-btn:active {
            transform: translateY(0);
        }

        .store-selector-btn::after {
            content: '▼';
            font-size: 10px;
            margin-right: 8px;
        }

        .store-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            left: 0;
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gold-light);
            margin-top: 8px;
            display: none;
            z-index: 1001;
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        #citySearchInput {
            direction: rtl;
            text-align: right;
        }

        .store-dropdown.show {
            display: block;
        }

        .store-option {
            padding: 14px 18px;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-light);
            transition: all 0.2s ease;
            font-weight: 500;
            color: var(--black-primary);
        }

        .store-option:last-child {
            border-bottom: none;
        }

        .store-option:hover {
            background: linear-gradient(90deg, var(--gold-light) 0%, transparent 100%);
            padding-right: 22px;
        }

        .address-btn {
            padding: 12px 24px;
            background: var(--black-primary);
            color: var(--white);
            border: 2px solid var(--gold-primary);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            letter-spacing: 0.3px;
        }

        .address-btn:hover {
            background: var(--gold-primary);
            color: var(--black-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-gold);
        }

        .menu-btn {
            padding: 12px 18px;
            background: var(--black-primary);
            color: var(--gold-primary);
            border: 2px solid var(--gold-primary);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: var(--shadow-sm);
        }

        .menu-btn:hover {
            background: var(--gold-primary);
            color: var(--black-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-gold);
        }

        .menu-btn::before {
            content: '☰';
            font-size: 18px;
        }

        .back-btn {
            padding: 10px 16px;
            background: var(--black-primary);
            color: var(--gold-primary);
            border: 2px solid var(--gold-primary);
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            box-shadow: var(--shadow-sm);
            margin-left: 20px;
            flex-shrink: 0;
        }

        .back-btn:hover {
            background: var(--gold-primary);
            color: var(--black-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-gold);
        }

        .back-btn::before {
            content: '←';
            font-size: 20px;
        }

        .accordion-menu {
            position: fixed;
            top: 70px;
            left: 20px;
            background: var(--white);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gold-light);
            display: none;
            z-index: 1002;
            min-width: 220px;
            overflow: hidden;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .accordion-menu.show {
            display: block;
        }

        .accordion-item {
            border-bottom: 1px solid var(--gray-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .accordion-item:last-child {
            border-bottom: none;
        }

        .accordion-item:hover {
            background: linear-gradient(90deg, var(--gold-light) 0%, transparent 100%);
        }

        .accordion-item-content {
            padding: 16px 20px;
            font-size: 15px;
            color: var(--black-primary);
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .accordion-item-content::after {
            content: '›';
            font-size: 20px;
            color: var(--gold-primary);
            font-weight: bold;
        }

        /* Content Area */
        .content-area {
            padding: 24px 20px;
            min-height: calc(100vh - 160px);
        }

        .search-results {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-thread {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.6;
            position: relative;
            word-break: break-word;
        }

        .message-user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-secondary) 100%);
            color: var(--black-primary);
            border-bottom-right-radius: 4px;
            box-shadow: var(--shadow-sm);
            font-weight: 500;
        }

        .message-bot {
            align-self: flex-start;
            background: var(--white);
            color: var(--black-primary);
            border-bottom-left-radius: 4px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-light);
        }

        .message-text {
            white-space: pre-wrap;
        }

        .message-media {
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message-media img {
            width: 100%;
            border-radius: 12px;
            object-fit: cover;
        }

        .message-media figcaption {
            font-size: 13px;
            color: #333;
            padding: 8px 0 0 0;
            line-height: 1.5;
            text-align: right;
        }

        .message-location {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .message-location a {
            color: #0088cc;
            text-decoration: none;
            font-weight: 600;
        }

        .message-location a:hover {
            text-decoration: underline;
        }

        .location-coords {
            font-size: 12px;
            color: #666;
        }

        .message-status {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
            text-align: left;
        }

        .typing-dots::after {
            content: '…';
            animation: blink 1.2s infinite;
        }

        @keyframes blink {
            0% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }

        .result-item {
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gold-light);
            animation: fadeIn 0.4s ease-in;
            transition: all 0.3s ease;
        }

        .result-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-image {
            width: 100%;
            height: 200px;
            background-color: #4caf50;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .result-text {
            padding: 12px 16px;
            font-size: 14px;
            color: #333;
            line-height: 1.6;
        }

        .result-text-only {
            padding: 16px;
            font-size: 14px;
            color: #333;
            line-height: 1.6;
        }

        .store-folder {
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 2px solid var(--gold-light);
            animation: fadeIn 0.4s ease-in;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .store-folder:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--gold-primary);
        }

        .store-folder-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: var(--gray-light);
        }

        .store-folder-name {
            padding: 12px 16px 8px;
            font-size: 16px;
            color: #333;
            font-weight: 600;
            text-align: center;
            border-bottom: 1px solid var(--gold-light);
        }

        .store-folder-text {
            padding: 8px 16px 12px;
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            text-align: center;
        }

        /* Search Bar */
        .search-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--white) 0%, var(--cream-light) 100%);
            box-shadow: 0 -4px 20px rgba(26, 26, 26, 0.1);
            border-top: 2px solid var(--gold-light);
            padding: 16px 20px;
            z-index: 1000;
            display: flex;
            gap: 12px;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .search-input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid var(--gray-light);
            border-radius: 30px;
            font-size: 15px;
            direction: rtl;
            outline: none;
            transition: all 0.3s ease;
            background: var(--white);
            font-weight: 500;
        }

        .search-input:focus {
            border-color: var(--gold-primary);
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1);
        }

        .search-input::placeholder {
            color: #999;
            opacity: 1;
        }

        .search-input::-webkit-input-placeholder {
            color: #999;
        }

        .search-input::-moz-placeholder {
            color: #999;
            opacity: 1;
        }

        .search-input:-ms-input-placeholder {
            color: #999;
        }

        .search-btn {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-secondary) 100%);
            color: var(--black-primary);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
            transition: all 0.3s ease;
            flex-shrink: 0;
            box-shadow: var(--shadow-gold);
        }

        .search-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 24px rgba(212, 175, 55, 0.35);
        }

        .search-btn:active {
            transform: scale(0.95);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(26, 26, 26, 0.7);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--white) 0%, var(--cream-light) 100%);
            border-radius: 24px;
            padding: 32px;
            max-width: 420px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.4s ease-out;
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--gold-light);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--black-primary);
            text-align: center;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--gold-light);
            letter-spacing: 0.5px;
        }

        .modal-body {
            margin-bottom: 20px;
            color: #666;
            line-height: 1.6;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-secondary) 100%);
            color: var(--black-primary);
            font-weight: 600;
            box-shadow: var(--shadow-gold);
            transition: all 0.3s ease;
        }

        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(212, 175, 55, 0.35);
        }

        .modal-btn-secondary {
            background: var(--gray-light);
            color: var(--black-primary);
            font-weight: 500;
            border: 1px solid var(--gray-medium);
            transition: all 0.3s ease;
        }

        .modal-btn-secondary:hover {
            background: var(--gray-medium);
            color: var(--white);
            transform: translateY(-2px);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--gray-light);
            border-radius: 12px;
            font-size: 15px;
            direction: rtl;
            outline: none;
            transition: all 0.3s ease;
            background: var(--white);
            font-weight: 500;
        }

        .form-input:focus {
            border-color: var(--gold-primary);
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1);
        }

        .form-textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--gray-light);
            border-radius: 12px;
            font-size: 15px;
            direction: rtl;
            outline: none;
            resize: vertical;
            min-height: 120px;
            transition: all 0.3s ease;
            font-family: inherit;
            background: var(--white);
            font-weight: 500;
        }

        .form-textarea:focus {
            border-color: var(--gold-primary);
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1);
        }

        .form-submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-secondary) 100%);
            color: var(--black-primary);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-gold);
            letter-spacing: 0.5px;
            margin-top: 8px;
        }

        .form-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(212, 175, 55, 0.35);
        }

        .form-submit-btn:active {
            transform: translateY(0);
        }

        .form-submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .contact-info-section {
            background: linear-gradient(135deg, var(--gold-light) 0%, rgba(212, 175, 55, 0.1) 100%);
            border: 2px solid var(--gold-light);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .contact-info-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--black-primary);
            margin-bottom: 16px;
            text-align: center;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
        }

        .contact-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .contact-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: var(--white);
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        .contact-info-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .contact-info-icon {
            font-size: 18px;
            min-width: 24px;
            text-align: center;
        }

        .contact-info-icon img {
            width: 24px;
            height: 24px;
            object-fit: contain;
            display: block;
        }

        .contact-info-content {
            flex: 1;
            font-size: 13px;
            color: #333;
            direction: ltr;
            text-align: left;
            word-break: break-all;
        }

        .contact-info-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 2px;
            font-weight: 500;
        }

        .contact-info-value {
            font-size: 13px;
            color: var(--black-primary);
            font-weight: 600;
        }

        .contact-info-item a {
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .contact-info-item a:hover .contact-info-value {
            color: var(--gold-primary);
        }

        @media (max-width: 480px) {
            .contact-info-grid {
                grid-template-columns: 1fr;
            }
        }

        .gold-price-container {
            padding: 16px 0;
        }

        .gold-price-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .gold-price-item:last-child {
            border-bottom: none;
        }

        .gold-price-label {
            font-weight: 500;
            color: #333;
        }

        .gold-price-value {
            color: var(--gold-primary);
            font-weight: 700;
            font-size: 16px;
        }

        /* Admin Dashboard */
        .admin-dashboard {
            display: none;
            padding: 16px;
            padding-bottom: 180px;
            min-height: calc(100vh - 160px);
            flex-direction: column;
            position: relative;
        }

        .admin-dashboard.show {
            display: flex;
        }

        .admin-help-text {
            padding: 40px 20px;
            margin: 20px 0;
            text-align: right;
        }

        .admin-help-list {
            list-style: none;
            padding: 0;
            margin: 0;
            color: #999;
            font-size: 14px;
            line-height: 1.8;
        }

        .admin-help-list li {
            margin-bottom: 16px;
            padding-right: 24px;
            position: relative;
        }

        .admin-help-list li::before {
            content: '•';
            position: absolute;
            right: 0;
            color: #999;
            font-size: 18px;
            font-weight: bold;
        }

        .admin-help-list li:last-child {
            margin-bottom: 0;
        }

        .admin-buttons-top {
            display: none;
        }

        .admin-buttons-bottom {
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background-color: #f5f5f5;
            z-index: 100;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
        }

        .admin-buttons-row {
            display: flex;
            gap: 12px;
        }

        .admin-buttons-row .admin-btn {
            flex: 1;
        }

        .admin-btn {
            padding: 18px 24px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-md);
            letter-spacing: 0.3px;
        }

        .admin-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .admin-btn-support {
            background: linear-gradient(135deg, var(--black-primary) 0%, var(--black-secondary) 100%);
            color: var(--gold-primary);
            border: 2px solid var(--gold-primary);
        }

        .admin-btn-support:hover {
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-secondary) 100%);
            color: var(--black-primary);
            transform: translateY(-3px);
            box-shadow: var(--shadow-gold);
        }

        .admin-btn-products {
            background: linear-gradient(135deg, var(--black-primary) 0%, var(--black-secondary) 100%);
            color: var(--gold-primary);
            border: 2px solid var(--gold-primary);
        }

        .admin-btn-products:hover {
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-secondary) 100%);
            color: var(--black-primary);
            transform: translateY(-3px);
            box-shadow: var(--shadow-gold);
        }

        .admin-btn-update {
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-secondary) 100%);
            color: var(--black-primary);
            border: 2px solid var(--gold-dark);
        }

        .admin-btn-update:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-gold);
            background: linear-gradient(135deg, var(--gold-secondary) 0%, var(--gold-primary) 100%);
        }

        .admin-btn-delete {
            background: linear-gradient(135deg, #C41E3A 0%, #8B0000 100%);
            color: var(--white);
            border: 2px solid #8B0000;
        }

        .admin-btn-delete:hover {
            background: linear-gradient(135deg, #8B0000 0%, #C41E3A 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 24px rgba(196, 30, 58, 0.35);
        }

        .admin-btn-add {
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-secondary) 100%);
            color: var(--black-primary);
            border: 2px solid var(--gold-dark);
        }

        .admin-btn-add:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-gold);
            background: linear-gradient(135deg, var(--gold-secondary) 0%, var(--gold-primary) 100%);
        }

        /* Admin Pages */
        .admin-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--cream-bg) 0%, var(--cream-light) 100%);
            z-index: 2000;
            padding: 20px 10px 10px 10px;
            overflow-y: auto;
        }

        .admin-page.show {
            display: block;
        }

        .admin-page-content {
            background: linear-gradient(135deg, var(--white) 0%, var(--cream-light) 100%);
            border: 2px solid var(--gold-primary);
            border-radius: 24px;
            padding: 32px;
            padding-left: 80px;
            max-width: 90%;
            width: 100%;
            margin: 0 auto;
            position: relative;
            box-shadow: var(--shadow-lg);
        }
        
        #storeDetailPage .admin-page-content {
            max-width: 98%;
            width: calc(100% - 20px);
            padding: 24px;
            padding-left: 60px;
            min-height: calc(100vh - 40px);
        }

        .admin-page-back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 48px;
            height: 48px;
            background: var(--black-primary);
            color: var(--gold-primary);
            border: 2px solid var(--gold-primary);
            border-radius: 12px;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
            box-shadow: var(--shadow-sm);
        }

        .admin-page-back-btn:hover {
            background: var(--gold-primary);
            color: var(--black-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-gold);
        }

        .admin-page-back-btn:active {
            transform: scale(0.95);
        }

        #deleteEditPage .admin-page-content {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: calc(100vh - 160px);
            padding-bottom: 40px;
        }

        .delete-edit-bottom-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            padding: 0 4px;
            box-sizing: border-box;
        }

        .delete-edit-label {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }

        .delete-edit-form {
            display: flex;
            flex-direction: row-reverse;
            gap: 8px;
            align-items: center;
            width: 100%;
            padding-right: 0;
            box-sizing: border-box;
        }

        .delete-edit-input {
            flex: 1;
            min-width: 0;
            padding: 10px 16px;
            border: 2px solid #0088cc;
            border-radius: 24px;
            font-size: 14px;
            direction: rtl;
            outline: none;
            transition: border-color 0.2s;
            font-family: inherit;
            box-sizing: border-box;
        }

        .delete-edit-input:focus {
            border-color: #0077b3;
        }

        .delete-edit-send-btn {
            width: 44px;
            height: 44px;
            min-width: 44px;
            background-color: #0088cc;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s;
            flex-shrink: 0;
        }

        .delete-edit-send-btn:hover {
            background-color: #0077b3;
        }

        .delete-edit-send-btn:active {
            transform: scale(0.95);
        }

        .delete-edit-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .delete-edit-results {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 20px;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            padding: 16px 0;
        }

        .delete-edit-image-item {
            background-color: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delete-edit-image-item:hover {
            border-color: #0088cc;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .delete-edit-image-item.selected {
            border-color: #0088cc;
            background-color: #f0f8ff;
            box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.2);
        }

        .delete-edit-image-item img {
            width: 100%;
            border-radius: 8px;
            object-fit: cover;
            margin-bottom: 8px;
        }

        .delete-edit-image-caption {
            font-size: 14px;
            color: #333;
            text-align: right;
            padding: 8px 0;
            line-height: 1.5;
        }

        .delete-edit-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px solid #e0e0e0;
        }

        .delete-edit-action-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .delete-edit-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .delete-edit-action-btn-delete {
            background-color: #ff3b30;
            color: white;
        }

        .delete-edit-action-btn-delete:hover:not(:disabled) {
            background-color: #e6342a;
            transform: scale(1.02);
        }

        .delete-edit-action-btn-edit {
            background-color: #34c759;
            color: white;
        }

        .delete-edit-action-btn-edit:hover:not(:disabled) {
            background-color: #30b050;
            transform: scale(1.02);
        }

        .delete-edit-loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-size: 14px;
        }

        .delete-edit-loading .micro-progress-container {
            padding: 30px 20px;
        }

        .delete-edit-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 14px;
        }

        .admin-form-group {
            margin-bottom: 20px;
        }

        .admin-form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .admin-form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #0088cc;
            border-radius: 8px;
            font-size: 14px;
            direction: rtl;
            outline: none;
            transition: border-color 0.2s;
            font-family: inherit;
            box-sizing: border-box;
        }

        .admin-form-input:focus {
            border-color: #0077b3;
        }

        .admin-form-input::placeholder {
            color: #999;
            opacity: 1;
        }

        .admin-form-input::-webkit-input-placeholder {
            color: #999;
        }

        .admin-form-input::-moz-placeholder {
            color: #999;
            opacity: 1;
        }

        .admin-form-input:-ms-input-placeholder {
            color: #999;
        }

        /* Success Checkmark Animation */
        .success-checkmark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10001;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .success-checkmark-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #22c55e;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: checkmarkScale 0.5s ease-out;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
        }

        .success-checkmark-icon {
            width: 40px;
            height: 40px;
            position: relative;
        }

        .success-checkmark-icon::before {
            content: '';
            position: absolute;
            width: 4px;
            height: 18px;
            background: white;
            left: 14px;
            top: 18px;
            transform: rotate(-45deg);
            transform-origin: bottom;
            animation: checkmarkDraw1 0.3s ease-out 0.3s both;
            border-radius: 2px;
        }

        .success-checkmark-icon::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 24px;
            background: white;
            left: 20px;
            top: 8px;
            transform: rotate(45deg);
            transform-origin: bottom;
            animation: checkmarkDraw2 0.3s ease-out 0.5s both;
            border-radius: 2px;
        }

        @keyframes checkmarkScale {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes checkmarkDraw1 {
            0% {
                height: 0;
                opacity: 0;
            }
            100% {
                height: 18px;
                opacity: 1;
            }
        }

        @keyframes checkmarkDraw2 {
            0% {
                height: 0;
                opacity: 0;
            }
            100% {
                height: 24px;
                opacity: 1;
            }
        }

        .success-checkmark-fadeout {
            animation: checkmarkFadeOut 0.3s ease-out forwards;
        }

        @keyframes checkmarkFadeOut {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        /* Micro Progress Indicator */
        .micro-progress-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px 20px;
            gap: 24px;
        }

        .micro-progress-bar {
            width: 100%;
            max-width: 300px;
            height: 4px;
            background-color: var(--gray-light);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .micro-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--gold-primary) 0%, var(--gold-secondary) 100%);
            border-radius: 2px;
            animation: progressFill 7s ease-out forwards;
            box-shadow: 0 0 8px rgba(212, 175, 55, 0.5);
        }

        @keyframes progressFill {
            0% {
                width: 0%;
            }
            100% {
                width: 100%;
            }
        }

        .micro-progress-text {
            text-align: center;
            font-size: 14px;
            color: var(--gray-dark);
            line-height: 1.8;
            padding: 0 10px;
            max-width: 400px;
        }

        .micro-progress-text .prefix {
            font-weight: 600;
            color: var(--gold-dark);
            margin-bottom: 4px;
            display: block;
        }

        .image-upload-area {
            margin-top: 8px;
        }

        .image-upload-area input[type="file"] {
            display: none;
        }

        .image-preview {
            margin-top: 12px;
            width: 100%;
            min-height: 200px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            background-color: #fafafa;
        }

        .image-preview:hover {
            border-color: #0088cc;
        }

        .image-upload-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #666;
        }

        .upload-icon {
            font-size: 48px;
        }

        .upload-text {
            font-size: 14px;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            object-fit: contain;
        }

        .admin-send-btn {
            width: 60px;
            height: 60px;
            background-color: #0088cc;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto 0;
            box-shadow: 0 2px 8px rgba(0, 136, 204, 0.3);
        }

        .admin-send-btn:hover {
            background-color: #0077b3;
            transform: scale(1.05);
        }

        .admin-send-btn:active {
            transform: scale(0.95);
        }

        .admin-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .send-icon {
            font-size: 24px;
            line-height: 1;
        }

        /* Colored Pages */
        .colored-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .colored-page.show {
            display: flex;
        }

        .colored-page.green {
            background-color: #34c759;
        }

        .colored-page.red {
            background-color: #ff3b30;
        }

        .colored-page-content {
            background-color: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .colored-page-content h2 {
            margin-bottom: 16px;
            color: #333;
        }

        .colored-page-close {
            margin-top: 20px;
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-secondary) 100%);
            color: var(--black-primary);
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--shadow-gold);
            transition: all 0.3s ease;
        }

        .colored-page-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(212, 175, 55, 0.35);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-medium);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.6;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 24px;
            color: var(--gold-primary);
            font-weight: 500;
            font-size: 15px;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .header {
                padding: 10px 12px;
            }

            .content-area {
                padding: 12px;
            }

            .search-bar {
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header" id="mainHeader">
        <div class="header-content">
            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                <div class="store-selector">
                    <button class="store-selector-btn" id="storeSelectorBtn">
                        همه مغازه ها
                    </button>
                    <div class="store-dropdown" id="storeDropdown">
                        <div class="store-option" data-store="">همه مغازه ها</div>
                    </div>
                </div>
                <div class="city-selector">
                    <button class="city-selector-btn" id="citySelectorBtn">
                        همه شهرها
                    </button>
                    <div class="store-dropdown" id="cityDropdown">
                        <input type="text" id="citySearchInput" placeholder="جستجوی شهر..." style="padding: 8px; margin: 8px; border: 1px solid var(--gold-light); border-radius: 8px; width: calc(100% - 16px);" />
                        <div class="store-option" data-city="">همه شهرها</div>
                        <div class="store-option" data-city="آمل">آمل</div>
                        <div class="store-option" data-city="بابل">بابل</div>
                        <div class="store-option" data-city="آنلاین">آنلاین</div>
                    </div>
                </div>
            </div>
            <div class="header-admin-buttons">
                <button class="header-admin-btn header-admin-btn-products" id="headerProductsBtn">10 محصول آخر</button>
                <button class="header-admin-btn header-admin-btn-support" id="headerSupportBtn">پشتیبانی</button>
            </div>
            <button class="menu-btn" id="menuBtn"></button>
            <button class="back-btn" id="backBtn" style="display: none;"></button>
        </div>
    </div>

    <!-- Accordion Menu -->
    <div class="accordion-menu" id="accordionMenu">
        <div class="accordion-item" id="contactMenuItem">
            <div class="accordion-item-content">ارتباط با ما</div>
        </div>
        <div class="accordion-item" id="loginMenuItem">
            <div class="accordion-item-content">ورود طلافروشان</div>
        </div>
        <div class="accordion-item" id="goldPriceMenuItem">
            <div class="accordion-item-content">قیمت روز طلا</div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="content-area" id="mainContentArea">
        <div class="search-results chat-thread" id="searchResults">
            <div class="empty-state">
                <div class="empty-state-icon">🔍</div>
                <div>برای جستجو، ابتدا شهر را از منو بالا سمت چپ انتخاب کرده، سپس نوع طلا، قیمت و ... را در پایین وارد کنید</div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div class="admin-dashboard" id="adminDashboard">
        <div class="admin-buttons-top"></div>
        <div class="admin-help-text">
            <ul class="admin-help-list">
                <li>جهت افزودن محصول جدید به گالری بر روی "افزودن" و جهت حذف یا ادیت آن بر روی "حذف یا ادیت" کلیک کنید</li>
                <li>پس از افزودن محصولات به گالری میتوانید بر روی "آپدیت قیمت ها" کلیک کنید تا قیمت ها با توجه به وزن طلا و کارمزد اپدیت شوند</li>
                <li>برای مشاهده 10 محصول آخر اضافه شده بر روی "10 محصول آخر" کلیک کنید</li>
            </ul>
        </div>
        <div class="admin-buttons-bottom">
            <button class="admin-btn admin-btn-update" id="updatePricesBtn">آپدیت قیمت ها</button>
            <div class="admin-buttons-row">
                <button class="admin-btn admin-btn-add" id="addBtn">افزودن</button>
                <button class="admin-btn admin-btn-delete" id="deleteEditBtn">حذف یا ادیت</button>
            </div>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="search-bar">
        <input type="text" class="search-input" id="searchInput" placeholder="دستبند تیفانی بین 30 تا 40" />
        <button class="search-btn" id="searchBtn">↑</button>
    </div>

    <!-- Address Modal -->
    <div class="modal" id="addressModal">
        <div class="modal-content">
            <div class="modal-header">آدرس فروشگاه</div>
            <div class="modal-body" id="modalAddress">
                در حال بارگذاری...
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="closeModalBtn">بستن</button>
                <button class="modal-btn modal-btn-primary" id="viewMapBtn">مشاهده روی نقشه</button>
            </div>
        </div>
    </div>

    <!-- Contact Us Modal -->
    <div class="modal" id="contactModal">
        <div class="modal-content">
            <div class="modal-header">ارتباط با ما</div>
            <div class="modal-body">
                <div class="contact-info-section">
                    <div class="contact-info-title">اطلاعات تماس</div>
                    <div class="contact-info-grid">
                        <a href="tel:09014483290" class="contact-info-item">
                            <div class="contact-info-icon">📞</div>
                            <div class="contact-info-content">
                                <div class="contact-info-label">شماره تماس</div>
                                <div class="contact-info-value">09014483290</div>
                            </div>
                        </a>
                        <a href="mailto:iranzarpuy@gmail.com" class="contact-info-item">
                            <div class="contact-info-icon">✉️</div>
                            <div class="contact-info-content">
                                <div class="contact-info-label">ایمیل</div>
                                <div class="contact-info-value">iranzarpuy@gmail.com</div>
                            </div>
                        </a>
                        <a href="https://instagram.com/zar.puy" target="_blank" rel="noopener noreferrer" class="contact-info-item">
                            <div class="contact-info-icon">
                                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cdefs%3E%3ClinearGradient id='instagram-gradient' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23f09433;stop-opacity:1' /%3E%3Cstop offset='25%25' style='stop-color:%23e6683c;stop-opacity:1' /%3E%3Cstop offset='50%25' style='stop-color:%23dc2743;stop-opacity:1' /%3E%3Cstop offset='75%25' style='stop-color:%23cc2366;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23bc1888;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='24' height='24' rx='5' fill='url(%23instagram-gradient)'/%3E%3Cpath d='M12 8.5c-1.93 0-3.5 1.57-3.5 3.5s1.57 3.5 3.5 3.5 3.5-1.57 3.5-3.5-1.57-3.5-3.5-3.5zm0 5.75c-1.24 0-2.25-1.01-2.25-2.25S10.76 9.75 12 9.75s2.25 1.01 2.25 2.25S13.24 14.25 12 14.25z' fill='white'/%3E%3Ccircle cx='16.5' cy='7.5' r='1' fill='white'/%3E%3Cpath d='M17 12c0-2.76-2.24-5-5-5s-5 2.24-5 5 2.24 5 5 5 5-2.24 5-5zm-1.5 0c0 1.93-1.57 3.5-3.5 3.5S8.5 13.93 8.5 12s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5z' fill='white'/%3E%3C/svg%3E" alt="Instagram" style="width: 24px; height: 24px;" />
                            </div>
                            <div class="contact-info-content">
                                <div class="contact-info-label">اینستاگرام</div>
                                <div class="contact-info-value">@zar.puy</div>
                            </div>
                        </a>
                        <a href="https://t.me/+98" target="_blank" rel="noopener noreferrer" class="contact-info-item">
                            <div class="contact-info-icon">
                                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='12' fill='%2328A7E8'/%3E%3Cpath d='M17.47 5.47l-2.12 10.01c-.15.67-.54.83-1.1.52l-3.04-2.24-1.47 1.41c-.17.17-.32.32-.66.32l.21-2.98 5.63-5.09c.25-.22-.05-.34-.37-.12l-6.97 4.4-3.01-.94c-.66-.2-.68-.66.14-1l11.85-4.57c.55-.21 1.04.13.86.89z' fill='white'/%3E%3C/svg%3E" alt="Telegram" style="width: 24px; height: 24px;" />
                            </div>
                            <div class="contact-info-content">
                                <div class="contact-info-label">تلگرام</div>
                                <div class="contact-info-value">+98</div>
                            </div>
                        </a>
                    </div>
                </div>
                <form id="contactForm">
                    <div class="form-group">
                        <label class="form-label" for="contactName">نام</label>
                        <input type="text" class="form-input" id="contactName" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="contactPhone">شماره تماس</label>
                        <input type="tel" class="form-input" id="contactPhone" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="contactText">متن</label>
                        <textarea class="form-textarea" id="contactText" required></textarea>
                    </div>
                    <button type="submit" class="form-submit-btn" id="contactSubmitBtn">ارسال</button>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="closeContactModalBtn">بستن</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">ورود</div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="loginUsername">نام کاربری</label>
                        <input type="text" class="form-input" id="loginUsername" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="loginPassword">رمز عبور</label>
                        <input type="password" class="form-input" id="loginPassword" required />
                    </div>
                    <button type="submit" class="form-submit-btn" id="loginSubmitBtn">ورود</button>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" id="passwordResetBtn">تنظیم یا تغییر رمز عبور</button>
                <button class="modal-btn modal-btn-secondary" id="closeLoginModalBtn">بستن</button>
            </div>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div class="modal" id="passwordResetModal">
        <div class="modal-content">
            <div class="modal-header">تنظیم یا تغییر رمز عبور</div>
            <div class="modal-body">
                <form id="passwordResetForm">
                    <div class="form-group">
                        <label class="form-label" for="passwordResetPhone">شماره تماس</label>
                        <input type="tel" class="form-input" id="passwordResetPhone" required />
                    </div>
                    <button type="submit" class="form-submit-btn" id="passwordResetSubmitBtn">ارسال</button>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="closePasswordResetModalBtn">بستن</button>
            </div>
        </div>
    </div>

    <!-- Store Setup Modal -->
    <div class="modal" id="storeSetupModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">تنظیم اطلاعات فروشگاه</div>
            <div class="modal-body">
                <form id="storeSetupForm">
                    <div class="form-group">
                        <label class="form-label" for="storeSetupUsername">نام کاربری</label>
                        <input type="text" class="form-input" id="storeSetupUsername" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="storeSetupPassword">انتخاب رمز عبور</label>
                        <input type="password" class="form-input" id="storeSetupPassword" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="storeSetupMobile">شماره موبایل ثبت شده در این اپ</label>
                        <input type="tel" class="form-input" id="storeSetupMobile" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="storeSetupCode">کد 5 رقمی ارسال شده</label>
                        <input type="text" class="form-input" id="storeSetupCode" placeholder="کد 5 رقمی" maxlength="5" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">اطلاعات فروشگاه شامل نام، تلفن تماس و آدرس</label>
                        <input type="text" class="form-input" id="storeSetupName" placeholder="نام فروشگاه" required />
                        <input type="tel" class="form-input" id="storeSetupPhone" placeholder="تلفن تماس" required style="margin-top: 12px;" />
                        <input type="text" class="form-input" id="storeSetupAddress" placeholder="آدرس" required style="margin-top: 12px;" />
                    </div>
                    <div class="form-group">
                        <button type="button" class="form-submit-btn" id="storeSetupLocationBtn" style="background: var(--black-primary); color: var(--gold-primary); border: 2px solid var(--gold-primary); margin-top: 12px;">
                            ارسال موقعیت مکانی
                        </button>
                        <div id="storeSetupLocationDisplay" style="margin-top: 12px; padding: 12px; background: var(--gray-light); border-radius: 8px; display: none;">
                            <span id="storeSetupLocationText">موقعیت دریافت نشده</span>
                        </div>
                    </div>
                    <button type="submit" class="form-submit-btn" id="storeSetupSubmitBtn">ارسال</button>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="closeStoreSetupModalBtn">بستن</button>
            </div>
        </div>
    </div>

    <!-- Google Maps Location Picker Modal -->
    <div class="modal" id="locationPickerModal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh; width: 600px;">
            <div class="modal-header">انتخاب موقعیت روی نقشه</div>
            <div class="modal-body" style="padding: 0;">
                <div id="map" style="width: 100%; height: 400px; border-radius: 12px; overflow: hidden;"></div>
                <div style="padding: 16px;">
                    <div id="selectedLocationInfo" style="padding: 12px; background: var(--gray-light); border-radius: 8px; margin-top: 12px; display: none;">
                        <div style="font-weight: 600; margin-bottom: 8px;">موقعیت انتخاب شده:</div>
                        <div id="selectedLocationText"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="closeLocationPickerModalBtn">لغو</button>
                <button class="modal-btn modal-btn-primary" id="confirmLocationBtn">تأیید موقعیت</button>
            </div>
        </div>
    </div>

    <!-- Gold Price Modal -->
    <div class="modal" id="goldPriceModal">
        <div class="modal-content">
            <div class="modal-header">قیمت روز طلا</div>
            <div class="modal-body">
                <div id="goldPriceContainer" class="gold-price-container">
                    <div class="loading">در حال بارگذاری...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="closeGoldPriceModalBtn">بستن</button>
            </div>
        </div>
    </div>

    <!-- Support Modal -->
    <div class="modal" id="supportModal">
        <div class="modal-content">
            <div class="modal-header">پشتیبانی</div>
            <div class="modal-body">
                <div class="contact-info-section" style="margin-bottom: 20px;">
                    <div class="contact-info-title" style="font-size: 14px; margin-bottom: 12px; padding-bottom: 8px;">تماس با ما: <a href="tel:09014483290" style="color: var(--gold-primary); text-decoration: none; font-weight: 700;">09014483290</a></div>
                </div>
                <form id="supportForm">
                    <div class="form-group">
                        <label class="form-label" for="supportText">متن</label>
                        <textarea class="form-textarea" id="supportText" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="supportNumber">شماره تماس</label>
                        <input type="tel" class="form-input" id="supportNumber" required />
                    </div>
                    <button type="submit" class="form-submit-btn" id="supportSubmitBtn">ارسال</button>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="closeSupportModalBtn">بستن</button>
            </div>
        </div>
    </div>

    <!-- Admin Delete/Edit Page -->
    <div class="admin-page" id="deleteEditPage" style="display: none;">
        <div class="admin-page-content">
            <button class="admin-page-back-btn" id="deleteEditPageBackBtn">←</button>
            <div class="delete-edit-results" id="deleteEditResults" style="display: none;"></div>
            <div class="delete-edit-bottom-container">
                <label class="delete-edit-label" for="deleteEditInput">کد طلا یا توضیحات محصول</label>
                <form id="deleteEditForm" class="delete-edit-form">
                    <input type="text" class="delete-edit-input" id="deleteEditInput" required />
                    <button type="submit" class="delete-edit-send-btn" id="deleteEditSubmitBtn">
                        <span class="send-icon">↑</span>
                    </button>
                </form>
                <div class="delete-edit-actions" id="deleteEditActions" style="display: none;">
                    <button class="delete-edit-action-btn delete-edit-action-btn-delete" id="deleteActionBtn">حذف</button>
                    <button class="delete-edit-action-btn delete-edit-action-btn-edit" id="editActionBtn">ادیت</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Add Page -->
    <div class="admin-page" id="addPage" style="display: none;">
        <div class="admin-page-content">
            <button class="admin-page-back-btn" id="addPageBackBtn">←</button>
            <form id="addForm">
                <div class="admin-form-group">
                    <label class="admin-form-label">بارگذاری تصویر</label>
                    <div class="image-upload-area">
                        <input type="file" id="imageInput" accept="image/*" />
                        <div class="image-preview" id="imagePreview">
                            <div class="image-upload-placeholder">
                                <span class="upload-icon">📎</span>
                                <span class="upload-text">بارگذاری تصویر</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="admin-form-group">
                    <label class="admin-form-label" for="goldCode">کد طلا</label>
                    <input type="text" class="admin-form-input" id="goldCode" />
                </div>
                <div class="admin-form-group">
                    <label class="admin-form-label" for="productDescription">توضیحات محصول شامل نوع (دستبند، ...)، مدل، نوع طلا (رز گلد ...)، وزن طلا و کارمزد آن <span style="color: #ff3b30;">(لطفا تنها قیمت سنگ یا نگین را وارد کنید، قیمت خود محصول را وارد نکنید)</span></label>
                    <input type="text" class="admin-form-input" id="productDescription" placeholder="دستبند مدل تیفانی، وزن 4.57، کارمزد 13" required />
                </div>
                <button type="submit" class="admin-send-btn" id="addSubmitBtn">
                    <span class="send-icon">↑</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Store Detail Page -->
    <div class="admin-page" id="storeDetailPage" style="display: none;">
        <div class="admin-page-content">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="admin-page-back-btn" id="storeDetailBackBtn">←</button>
                <button class="address-btn" id="storeDetailAddressBtn" style="margin: 0;">نقشه</button>
                <div style="flex: 1; text-align: right; min-width: 200px;">
                    <h2 id="storeDetailName" style="margin: 0 0 8px 0;">نام فروشگاه</h2>
                    <div id="storeDetailInfo" style="font-size: 12px; color: #666; line-height: 1.4;"></div>
                </div>
            </div>
            <div id="storeDetailAddressContainer" style="display: none; margin-bottom: 20px; padding: 16px; background: var(--gray-light); border-radius: 12px;">
                <div id="storeDetailAddressText" style="margin-bottom: 12px; font-size: 14px; color: #333;"></div>
                <div id="storeDetailAddressLocation" style="padding: 12px; background: white; border-radius: 8px;"></div>
            </div>
            <div id="storeDetailProducts" class="delete-edit-results" style="display: block; max-height: calc(100vh - 150px); overflow-y: auto; padding: 0; margin: 0;"></div>
        </div>
    </div>

    <!-- Colored Pages -->
    <div class="colored-page green" id="greenPage">
        <div class="colored-page-content">
            <h2>عملیات با موفقیت انجام شد</h2>
            <button class="colored-page-close" id="closeGreenPageBtn">بستن</button>
        </div>
    </div>

    <div class="colored-page red" id="redPage">
        <div class="colored-page-content">
            <h2>عملیات حذف انجام شد</h2>
            <button class="colored-page-close" id="closeRedPageBtn">بستن</button>
        </div>
    </div>

    <script>
        // City data structure
        const cityData = {
            'آمل': {
                stores: ['جواهری دژگان', 'جواهری ستارزاده', 'جواهری محمدی'],
                webhookUrl: 'https://33140-nwo6p.s1.irann8n.com/webhook-test/df17942e-9b77-4e51-84e5-6301cd0a930b'
            },
            'بابل': {
                stores: ['جواهری توکلی', 'جواهری امیری'],
                webhookUrl: 'https://33140-nwo6p.s1.irann8n.com/webhook-test/770eb30a-288a-41fc-9d2d-501860b1de3a'
            },
            'آنلاین': {
                stores: ['طلاسو'],
                webhookUrl: 'https://33140-nwo6p.s1.irann8n.com/webhook-test/053e875b-1a42-4d6a-9670-8289076dac38'
            }
        };
        
        // Function to find city by store name
        function findCityByStore(storeName) {
            if (!storeName || storeName === '') {
                return null;
            }
            for (const [city, data] of Object.entries(cityData)) {
                if (data.stores.includes(storeName)) {
                    return city;
                }
            }
            return null;
        }
        
        // Function to get webhook URL based on city
        function getWebhookUrlByCity(city) {
            if (!city || city === '') {
                // Default URL for "همه شهرها" or no city selected
                return 'https://33140-nwo6p.s1.irann8n.com/webhook-test/bc6b217a-7c36-4532-830e-1a592ef03390';
            }
            if (cityData[city] && cityData[city].webhookUrl) {
                return cityData[city].webhookUrl;
            }
            // Default URL for any other city
            return 'https://33140-nwo6p.s1.irann8n.com/webhook-test/bc6b217a-7c36-4532-830e-1a592ef03390';
        }
        
        let selectedCity = null; // No city selected by default
        let WEBHOOK_URL = 'https://33140-nwo6p.s1.irann8n.com/webhook-test/bc6b217a-7c36-4532-830e-1a592ef03390'; // Default URL
        const CONTACT_WEBHOOK_URL = 'https://33140-nwo6p.s1.irann8n.com/webhook-test/df17942e-9b77-4e51-84e5-6301cd0a930b';
        const GOLD_PRICE_WEBHOOK_URL = 'https://33140-nwo6p.s1.irann8n.com/webhook/bc5d867f-e95f-412f-921f-1819407f27fa';
        const LOGIN_WEBHOOK_URL = 'https://33140-nwo6p.s1.irann8n.com/webhook/de4e77d3-0c12-4309-8dd3-1f657b62bfb6';
        const ADMIN_WEBHOOK_URL = 'https://33140-nwo6p.s1.irann8n.com/webhook/0bb445e1-3e17-4af3-b6f5-668723e9a53c';
        const PAGE_NAVIGATION_WEBHOOK_URL = 'https://33140-nwo6p.s1.irann8n.com/webhook/91991a96-0cdd-4dbc-860b-3dc9729a1823';
        let isSending = false;
        
        // Token and user management
        function getToken() {
            return localStorage.getItem('authToken');
        }
        
        function getUsername() {
            return localStorage.getItem('username');
        }
        
        function setToken(token) {
            if (token) {
                localStorage.setItem('authToken', token);
            } else {
                localStorage.removeItem('authToken');
            }
        }
        
        function setUsername(username) {
            if (username) {
                localStorage.setItem('username', username);
            } else {
                localStorage.removeItem('username');
            }
        }
        
        function clearToken() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('username');
        }

        // Check if user is authenticated
        function isAuthenticated() {
            const token = getToken();
            return token !== null && token !== undefined && token !== '';
        }

        // Redirect to login if not authenticated
        function requireAuth() {
            if (!isAuthenticated()) {
                clearToken();
                mainHeader.classList.remove('header-admin-mode');
                adminDashboard.classList.remove('show');
                if (typeof addPage !== 'undefined' && addPage) {
                    addPage.classList.remove('show');
                    addPage.style.display = 'none';
                }
                if (typeof deleteEditPage !== 'undefined' && deleteEditPage) {
                    deleteEditPage.classList.remove('show');
                    deleteEditPage.style.display = 'none';
                }
                mainContentArea.style.display = 'block';
                document.querySelector('.search-bar').style.display = 'flex';
                loginModal.classList.add('show');
                alert('لطفاً ابتدا وارد شوید');
                return false;
            }
            return true;
        }

        // Helper function to send authenticated requests with token and username
        async function sendAuthenticatedRequest(action, additionalData = {}) {
            const token = getToken();
            const username = getUsername();
            
            if (!token) {
                alert('لطفاً ابتدا وارد شوید');
                requireAuth();
                return null;
            }
            
            const payload = {
                action: action,
                token: token,
                username: username,
                timestamp: new Date().toISOString(),
                ...additionalData
            };
            
            try {
                const response = await fetch(ADMIN_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.message && (errorData.message.includes('token') || errorData.message.includes('unauthorized'))) {
                        clearToken();
                        requireAuth();
                        return null;
                    }
                    throw new Error(errorData.message || 'خطا در ارتباط با سرور');
                }
                
                return await response.json();
            } catch (error) {
                console.error(`Error in ${action}:`, error);
                throw error;
            }
        }

        // Store list (will be updated based on selected city)
        let stores = [];
        let selectedStore = ''; // No store selected by default
        
        // Store folder data map: requestId -> stores array (for event delegation)
        const storeFolderDataMap = new Map();
        let requestIdCounter = 0;

        // DOM Elements
        const citySelectorBtn = document.getElementById('citySelectorBtn');
        const cityDropdown = document.getElementById('cityDropdown');
        const citySearchInput = document.getElementById('citySearchInput');
        const storeSelectorBtn = document.getElementById('storeSelectorBtn');
        const storeDropdown = document.getElementById('storeDropdown');
        const addressBtn = document.getElementById('addressBtn');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const searchResults = document.getElementById('searchResults');
        const addressModal = document.getElementById('addressModal');
        const modalAddress = document.getElementById('modalAddress');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const viewMapBtn = document.getElementById('viewMapBtn');
        
        // Menu and Accordion Elements
        const menuBtn = document.getElementById('menuBtn');
        const backBtn = document.getElementById('backBtn');
        const accordionMenu = document.getElementById('accordionMenu');
        const contactMenuItem = document.getElementById('contactMenuItem');
        const loginMenuItem = document.getElementById('loginMenuItem');
        const goldPriceMenuItem = document.getElementById('goldPriceMenuItem');
        
        // Modal Elements
        const contactModal = document.getElementById('contactModal');
        const loginModal = document.getElementById('loginModal');
        const passwordResetModal = document.getElementById('passwordResetModal');
        const storeSetupModal = document.getElementById('storeSetupModal');
        const goldPriceModal = document.getElementById('goldPriceModal');
        const contactForm = document.getElementById('contactForm');
        const loginForm = document.getElementById('loginForm');
        const passwordResetForm = document.getElementById('passwordResetForm');
        const storeSetupForm = document.getElementById('storeSetupForm');
        const contactSubmitBtn = document.getElementById('contactSubmitBtn');
        const loginSubmitBtn = document.getElementById('loginSubmitBtn');
        const passwordResetSubmitBtn = document.getElementById('passwordResetSubmitBtn');
        const storeSetupSubmitBtn = document.getElementById('storeSetupSubmitBtn');
        const storeSetupLocationBtn = document.getElementById('storeSetupLocationBtn');
        const storeSetupLocationDisplay = document.getElementById('storeSetupLocationDisplay');
        const storeSetupLocationText = document.getElementById('storeSetupLocationText');
        const passwordResetBtn = document.getElementById('passwordResetBtn');
        const closeContactModalBtn = document.getElementById('closeContactModalBtn');
        const closeLoginModalBtn = document.getElementById('closeLoginModalBtn');
        const closePasswordResetModalBtn = document.getElementById('closePasswordResetModalBtn');
        const closeStoreSetupModalBtn = document.getElementById('closeStoreSetupModalBtn');
        const closeGoldPriceModalBtn = document.getElementById('closeGoldPriceModalBtn');
        const goldPriceContainer = document.getElementById('goldPriceContainer');
        
        // Admin Dashboard Elements
        const mainHeader = document.getElementById('mainHeader');
        const mainContentArea = document.getElementById('mainContentArea');
        const adminDashboard = document.getElementById('adminDashboard');
        const headerSupportBtn = document.getElementById('headerSupportBtn');
        const headerProductsBtn = document.getElementById('headerProductsBtn');
        const updatePricesBtn = document.getElementById('updatePricesBtn');
        const deleteEditBtn = document.getElementById('deleteEditBtn');
        const addBtn = document.getElementById('addBtn');
        const supportModal = document.getElementById('supportModal');
        const supportForm = document.getElementById('supportForm');
        const supportSubmitBtn = document.getElementById('supportSubmitBtn');
        const closeSupportModalBtn = document.getElementById('closeSupportModalBtn');
        const greenPage = document.getElementById('greenPage');
        const redPage = document.getElementById('redPage');
        const closeGreenPageBtn = document.getElementById('closeGreenPageBtn');
        const closeRedPageBtn = document.getElementById('closeRedPageBtn');
        const addPage = document.getElementById('addPage');
        const addForm = document.getElementById('addForm');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const addSubmitBtn = document.getElementById('addSubmitBtn');
        const addPageBackBtn = document.getElementById('addPageBackBtn');
        const deleteEditPage = document.getElementById('deleteEditPage');
        const deleteEditForm = document.getElementById('deleteEditForm');
        const deleteEditInput = document.getElementById('deleteEditInput');
        const deleteEditSubmitBtn = document.getElementById('deleteEditSubmitBtn');
        const deleteEditPageBackBtn = document.getElementById('deleteEditPageBackBtn');
        const deleteEditResults = document.getElementById('deleteEditResults');
        const deleteEditActions = document.getElementById('deleteEditActions');
        const deleteActionBtn = document.getElementById('deleteActionBtn');
        const editActionBtn = document.getElementById('editActionBtn');
        const storeDetailPage = document.getElementById('storeDetailPage');
        const storeDetailBackBtn = document.getElementById('storeDetailBackBtn');
        const storeDetailAddressBtn = document.getElementById('storeDetailAddressBtn');
        const storeDetailName = document.getElementById('storeDetailName');
        const storeDetailInfo = document.getElementById('storeDetailInfo');
        const storeDetailAddressContainer = document.getElementById('storeDetailAddressContainer');
        const storeDetailAddressText = document.getElementById('storeDetailAddressText');
        const storeDetailAddressLocation = document.getElementById('storeDetailAddressLocation');
        const storeDetailProducts = document.getElementById('storeDetailProducts');
        
        // Store current store data for detail page
        let currentStoreData = null;

        // Event delegation for store folder clicks (works even after cloning)
        searchResults.addEventListener('click', function(e) {
            const folder = e.target.closest('.store-folder');
            if (!folder) return;
            
            const requestId = folder.getAttribute('data-request-id');
            const storeName = folder.getAttribute('data-store-name');
            
            if (!requestId || !storeFolderDataMap.has(requestId)) return;
            
            const storesArray = storeFolderDataMap.get(requestId);
            
            // Reconstruct the storeGroup from storesArray
            let currentStore = null;
            const storesList = [];
            
            storesArray.forEach((item) => {
                if (item.store_name) {
                    if (currentStore) {
                        storesList.push(currentStore);
                    }
                    currentStore = {
                        store_name: item.store_name,
                        نتیجه: item.نتیجه || item.result || null,
                        store_info: item.store_info || item.storeInfo || item.info || null,
                        images: []
                    };
                } else if (currentStore) {
                    const imageUrl = item.image || item.url || item.image_url || item.photo || (item.type === 'image' ? item.url : '');
                    if (imageUrl) {
                        currentStore.images.push({
                            url: imageUrl,
                            info: item.info || item.text || item.caption || item.description || ''
                        });
                    }
                }
            });
            if (currentStore) {
                storesList.push(currentStore);
            }
            
            // Find the matching storeGroup
            const storeGroup = storesList.find(s => s.store_name === storeName);
            if (storeGroup) {
                showStoreDetailPage(storeGroup);
            }
        });

        // Function to update store list based on selected city
        function updateStoreList(city, preserveStoreSelection = false) {
            if (city && city !== '' && cityData[city]) {
                // Show only stores for the selected city
                stores = cityData[city].stores;
                WEBHOOK_URL = getWebhookUrlByCity(city);
                
                // Update store dropdown
                storeDropdown.innerHTML = '<div class="store-option" data-store="">همه مغازه ها</div>';
                stores.forEach(store => {
                    const option = document.createElement('div');
                    option.className = 'store-option';
                    option.setAttribute('data-store', store);
                    option.textContent = store;
                    storeDropdown.appendChild(option);
                });
                
                // Only reset store if we're not preserving the selection, or if current store doesn't belong to this city
                if (!preserveStoreSelection) {
                    selectedStore = '';
                    storeSelectorBtn.textContent = 'همه مغازه ها';
                } else {
                    // Check if current selected store belongs to this city
                    if (selectedStore && selectedStore !== '' && !stores.includes(selectedStore)) {
                        // Store doesn't belong to this city, reset to "همه مغازه ها"
                        selectedStore = '';
                        storeSelectorBtn.textContent = 'همه مغازه ها';
                    } else if (selectedStore && selectedStore !== '') {
                        // Store belongs to this city, keep it selected
                        storeSelectorBtn.textContent = selectedStore;
                    } else {
                        // No store was selected, set to "همه مغازه ها"
                        storeSelectorBtn.textContent = 'همه مغازه ها';
                    }
                }
            } else {
                // No city selected or "همه شهرها" - show all stores from all cities
                stores = [];
                Object.values(cityData).forEach(cityInfo => {
                    stores.push(...cityInfo.stores);
                });
                WEBHOOK_URL = 'https://33140-nwo6p.s1.irann8n.com/webhook-test/bc6b217a-7c36-4532-830e-1a592ef03390';
                
                // Update store dropdown
                storeDropdown.innerHTML = '<div class="store-option" data-store="">همه مغازه ها</div>';
                stores.forEach(store => {
                    const option = document.createElement('div');
                    option.className = 'store-option';
                    option.setAttribute('data-store', store);
                    option.textContent = store;
                    storeDropdown.appendChild(option);
                });
                
                // When "همه شهرها" is selected, always reset store to "همه مغازه ها"
                selectedStore = '';
                storeSelectorBtn.textContent = 'همه مغازه ها';
            }
            
            // Re-attach event listeners to new store options
            attachStoreOptionListeners();
        }
        
        // Function to attach event listeners to store options
        function attachStoreOptionListeners() {
        storeDropdown.querySelectorAll('.store-option').forEach(option => {
            option.addEventListener('click', function() {
                const clickedStore = this.getAttribute('data-store');
                
                // If a store is selected, automatically set the city
                if (clickedStore && clickedStore !== '') {
                    const cityForStore = findCityByStore(clickedStore);
                    if (cityForStore && cityForStore !== selectedCity) {
                        // City needs to change - update city first
                        selectedCity = cityForStore;
                        citySelectorBtn.textContent = cityForStore;
                        // Update store list to show only stores from the new city
                        updateStoreList(cityForStore);
                        // After store list is updated, set the selected store
                        selectedStore = clickedStore;
                        storeSelectorBtn.textContent = clickedStore;
                        // Update webhook URL based on city
                        WEBHOOK_URL = getWebhookUrlByCity(selectedCity);
                    } else {
                        // No city change needed, just set the store
                        selectedStore = clickedStore;
                        storeSelectorBtn.textContent = clickedStore || 'همه مغازه ها';
                    }
                } else {
                    // "همه مغازه ها" selected
                    selectedStore = '';
                    storeSelectorBtn.textContent = 'همه مغازه ها';
                }
                
                storeDropdown.classList.remove('show');
            });
        });
        }
        
        // City selector functionality
        citySelectorBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            cityDropdown.classList.toggle('show');
            if (cityDropdown.classList.contains('show')) {
                citySearchInput.focus();
            }
        });
        
        // City search input filtering
        if (citySearchInput) {
            citySearchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const options = cityDropdown.querySelectorAll('.store-option');
                options.forEach(option => {
                    const cityName = option.textContent.toLowerCase();
                    if (cityName.includes(searchTerm)) {
                        option.style.display = 'block';
                    } else {
                        option.style.display = 'none';
                    }
                });
            });
        }
        
        // City option selection
        cityDropdown.querySelectorAll('.store-option').forEach(option => {
            option.addEventListener('click', function() {
                const city = this.getAttribute('data-city') || '';
                const previousCity = selectedCity;
                
                if (city === '') {
                    // "همه شهرها" selected - force reset store to "همه مغازه ها"
                    selectedCity = null;
                    citySelectorBtn.textContent = 'همه شهرها';
                    // Update store list (will force reset store)
                    updateStoreList(null, false);
                    // Update webhook URL
                    WEBHOOK_URL = getWebhookUrlByCity(null);
                } else {
                    // Specific city selected - preserve store selection if it belongs to this city
                    selectedCity = city;
                    citySelectorBtn.textContent = city;
                    // Update store list and preserve store selection if valid
                    updateStoreList(city, true);
                    // Update webhook URL based on selected city
                    WEBHOOK_URL = getWebhookUrlByCity(city);
                }
                
                cityDropdown.classList.remove('show');
                citySearchInput.value = '';
            });
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!citySelectorBtn.contains(e.target) && !cityDropdown.contains(e.target)) {
                cityDropdown.classList.remove('show');
            }
            if (!storeSelectorBtn.contains(e.target) && !storeDropdown.contains(e.target)) {
                storeDropdown.classList.remove('show');
            }
        });

        // Store selector functionality
        storeSelectorBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            storeDropdown.classList.toggle('show');
        });
        
        // Initialize store list (no city selected - show all)
        updateStoreList(null);

        function clearEmptyState() {
            const emptyState = searchResults.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
        }

        function scrollToBottom() {
            searchResults.scrollTop = searchResults.scrollHeight;
        }

        // Persian sentences array
        const goldFacts = [
            'تمام طلایی که تاکنون در جهان استخراج شده، در یک مکعب با ضلع حدود ۲۲ متر جا می‌شود.',
            'طلا هرگز زنگ نمی‌زند، فاسد نمی‌شود و خورده نمی‌شود.',
            'یک گرم طلا را می‌توان به سیمی به طول حدود ۲ کیلومتر کشید.',
            'طلا آن‌قدر نرم است که می‌توان با دندان روی آن اثر گذاشت.',
            'در آب دریا طلا وجود دارد، اما مقدار آن آن‌قدر کم است که استخراجش صرفه اقتصادی ندارد.',
            'تقریباً تمام طلای موجود روی زمین از انفجار ستاره‌ها به وجود آمده است.',
            'اتم‌های طلای زیورآلات ما قدیمی‌تر از خود زمین هستند.',
            'طلا خوراکی است و در برخی غذاهای لوکس استفاده می‌شود.',
            'طلا رسانای برق بهتری از مس است، اما به دلیل قیمت بالا کمتر استفاده می‌شود.',
            'رومی‌های باستان از طلا برای دندان‌پزشکی استفاده می‌کردند.',
            'اولین سکه‌های طلا بیش از ۲۶۰۰ سال پیش ساخته شدند.',
            'در دوره‌هایی از تاریخ، طلا ارزشمندتر از زمین بوده است.',
            'در قرون وسطی، پودر طلا به‌عنوان دارو مصرف می‌شد.',
            'انسان‌ها به‌طور غریزی جذب رنگ طلایی می‌شوند.',
            'طلا یکی از کم‌واکنش‌ترین عناصر شیمیایی است.',
            'ترکیب کمیابی و ماندگاری طلا باعث شده انسان‌ها به آن اعتماد کنند.'
        ];

        // Function to get random sentence
        function getRandomGoldFact() {
            const randomIndex = Math.floor(Math.random() * goldFacts.length);
            return goldFacts[randomIndex];
        }

        // Function to create micro-progress indicator HTML
        function createMicroProgressIndicator() {
            const container = document.createElement('div');
            container.className = 'micro-progress-container';
            
            const progressBar = document.createElement('div');
            progressBar.className = 'micro-progress-bar';
            
            const progressFill = document.createElement('div');
            progressFill.className = 'micro-progress-fill';
            progressBar.appendChild(progressFill);
            
            const textContainer = document.createElement('div');
            textContainer.className = 'micro-progress-text';
            
            const prefix = document.createElement('span');
            prefix.className = 'prefix';
            prefix.textContent = 'فکت طلایی :';
            
            const fact = document.createElement('span');
            fact.textContent = getRandomGoldFact();
            
            textContainer.appendChild(prefix);
            textContainer.appendChild(fact);
            
            container.appendChild(progressBar);
            container.appendChild(textContainer);
            
            return container;
        }

        function appendMessage(role, content, options = {}) {
            clearEmptyState();

            const messageEl = document.createElement('div');
            messageEl.classList.add('message', role === 'user' ? 'message-user' : 'message-bot');

            if (options.isPending) {
                messageEl.classList.add('typing-dots');
            }

            if (typeof content === 'string') {
                messageEl.textContent = content;
            } else if (content instanceof Node) {
                messageEl.appendChild(content);
            } else {
                messageEl.textContent = '';
            }

            searchResults.appendChild(messageEl);
            
            // Cleanup is handled by cleanupOldItems() which maintains chronological order
            // Skip cleanup if this is a loading message to prevent it from being removed
            if (!options.isPending) {
                cleanupOldItems();
            }
            
            scrollToBottom();

            return messageEl;
        }

        function updateMessage(messageEl, content) {
            if (!messageEl) return;
            messageEl.classList.remove('typing-dots');
            // Clear any pending/loading text
            messageEl.textContent = '';

            if (typeof content === 'string') {
                messageEl.textContent = content;
            } else if (content instanceof Node) {
                messageEl.innerHTML = '';
                messageEl.appendChild(content);
            } else {
                messageEl.textContent = '';
            }

            scrollToBottom();
        }

        function setSearchState(isLoading) {
            isSending = isLoading;
            searchBtn.disabled = isLoading;
            if (isLoading) {
                // Show loading indicator on button
                searchBtn.textContent = '⏳';
                searchBtn.style.opacity = '0.7';
            } else {
                // Restore normal button state
                searchBtn.textContent = '↑';
                searchBtn.style.opacity = '1';
                searchInput.focus();
            }
        }

        function createTextContent(text) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message-text';
            
            // If text looks like JSON, try to parse it and extract meaningful text
            let displayText = text;
            if (typeof text === 'string' && (text.trim().startsWith('{') || text.trim().startsWith('['))) {
                try {
                    const parsed = JSON.parse(text);
                    // Extract text values from JSON object
                    if (typeof parsed === 'object' && parsed !== null) {
                        const textValues = [];
                        // Recursively extract all string values
                        function extractText(obj) {
                            if (typeof obj === 'string' && obj.trim()) {
                                textValues.push(obj.trim());
                            } else if (Array.isArray(obj)) {
                                obj.forEach(extractText);
                            } else if (typeof obj === 'object' && obj !== null) {
                                Object.values(obj).forEach(extractText);
                            }
                        }
                        extractText(parsed);
                        // Join all text values with newlines, filtering out empty strings
                        displayText = textValues.filter(v => v && !v.match(/^[\{\}\[\]\:\,]+$/)).join('\n');
                        // If we couldn't extract meaningful text, use original
                        if (!displayText) {
                            displayText = text;
                        }
                    }
                } catch (e) {
                    // If parsing fails, use original text
                    displayText = text;
                }
            }
            
            wrapper.textContent = displayText;
            return wrapper;
        }

        function createImageContent({ url, caption }) {
            const figure = document.createElement('figure');
            figure.className = 'message-media';

            const img = document.createElement('img');
            img.src = url;
            img.alt = caption || 'تصویر';
            img.loading = 'lazy';
            figure.appendChild(img);

            if (caption) {
                const figcaption = document.createElement('figcaption');
                figcaption.textContent = caption;
                figure.appendChild(figcaption);
            }

            return figure;
        }

        function createLocationContent({ latitude, longitude, text, ادرس }) {
            const container = document.createElement('div');
            container.className = 'message-location';

            const description = document.createElement('div');
            description.textContent = text || 'موقعیت فروشگاه';

            // Display address text (ادرس) if available
            if (ادرس) {
                const addressDiv = document.createElement('div');
                addressDiv.style.cssText = 'margin-top: 8px; margin-bottom: 8px; padding: 8px; background: #f5f5f5; border-radius: 6px; font-size: 14px; color: #333; line-height: 1.5;';
                addressDiv.textContent = ادرس;
                container.appendChild(description);
                container.appendChild(addressDiv);
            } else {
                container.appendChild(description);
            }

            const link = document.createElement('a');
            link.href = `https://www.google.com/maps?q=${latitude},${longitude}`;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.textContent = 'مشاهده روی نقشه';

            const coords = document.createElement('div');
            coords.className = 'location-coords';
            coords.textContent = `${latitude}, ${longitude}`;

            container.appendChild(coords);
            container.appendChild(link);

            return container;
        }

        function detectInlineImageSource(value) {
            if (!value && value !== 0) {
                return null;
            }

            const trimmed = String(value).trim();

            if (!trimmed) {
                return null;
            }

            if (trimmed.startsWith('data:image')) {
                return trimmed;
            }

            if (/^https?:\/\/.+\.(png|jpe?g|gif|webp)(\?.*)?$/i.test(trimmed)) {
                return trimmed;
            }

            const sanitized = trimmed.replace(/\s+/g, '');
            const base64Hints = ['iVBOR', '/9j', 'R0lGOD', 'Qk2', 'Qk0', 'AAAB', 'UEsD'];
            const looksBase64 = /^[A-Za-z0-9+/=]+$/.test(sanitized) && base64Hints.some(hint => sanitized.startsWith(hint));

            if (looksBase64) {
                let mime = 'image/jpeg';
                if (sanitized.startsWith('iVBOR')) mime = 'image/png';
                else if (sanitized.startsWith('R0lGOD')) mime = 'image/gif';
                else if (sanitized.startsWith('Qk')) mime = 'image/bmp';

                return `data:${mime};base64,${sanitized}`;
            }

            return null;
        }

        function inferResponseType(data) {
            if (!data || typeof data !== 'object') {
                return 'text';
            }

            if (data.type) {
                return data.type;
            }

            if (data.latitude || data.lat) {
                return 'location';
            }

            if (data.url || data.image || data.image_url || data.photo) {
                return 'image';
            }

            return 'text';
        }

        const ARRAY_KEYS = [
            'items',
            'results',
            'data',
            'messages',
            'entries',
            'list',
            'payload',
            'value',
            'photos',
            'images',
            'media',
            'gallery',
            'files'
        ];

        function normalizeResponse(raw) {
            if (raw === null || raw === undefined) {
                return [];
            }

            if (typeof raw === 'string' || typeof raw === 'number') {
                const value = String(raw).trim();
                const inlineImage = detectInlineImageSource(value);
                if (inlineImage) {
                    return [{ type: 'image', url: inlineImage }];
                }
                return [{ type: 'text', text: value }];
            }

            if (Array.isArray(raw)) {
                return raw.flatMap(item => normalizeResponse(item));
            }

            if (typeof raw === 'object') {
                for (const key of ARRAY_KEYS) {
                    if (Array.isArray(raw[key])) {
                        const expanded = raw[key].flatMap(item => normalizeResponse(item));
                        if (expanded.length) {
                            return expanded;
                        }
                    }
                }

                const type = inferResponseType(raw);
                if (type === 'image') {
                    let source = raw.url || raw.image || raw.image_url || raw.photo;
                    if (!source && raw.data) {
                        source = detectInlineImageSource(raw.data);
                        if (!source) {
                            const mime = raw.mime || raw.mimetype || 'image/jpeg';
                            source = `data:${mime};base64,${String(raw.data).replace(/\s+/g, '')}`;
                        }
                    }

                    if (source) {
                        return [{
                            type: 'image',
                            url: source,
                            caption: raw.caption || raw.info || raw.text || raw.description || ''
                        }];
                    }
                }

                if (type === 'location') {
                    return [{
                        type: 'location',
                        latitude: raw.latitude || raw.lat,
                        longitude: raw.longitude || raw.lng || raw.lon,
                        text: raw.text || raw.caption || raw.description || '',
                        ادرس: raw.ادرس || raw.address || ''
                    }];
                }

                const text = raw.text || raw.message || raw.caption || raw.description || raw.نتیجه;
                if (text) {
                    return [{ type: 'text', text }];
                }

                // If no text field found, try to extract meaningful text from object
                const textValues = [];
                function extractText(obj, depth = 0) {
                    if (depth > 3) return; // Prevent deep recursion
                    if (typeof obj === 'string' && obj.trim() && !obj.match(/^[\{\}\[\]\:\,]+$/)) {
                        textValues.push(obj.trim());
                    } else if (Array.isArray(obj)) {
                        obj.forEach(item => extractText(item, depth + 1));
                    } else if (typeof obj === 'object' && obj !== null) {
                        Object.values(obj).forEach(value => extractText(value, depth + 1));
                    }
                }
                extractText(raw);
                
                // If we found text values, join them; otherwise return empty
                if (textValues.length > 0) {
                    return [{ type: 'text', text: textValues.join('\n') }];
                }
                
                return [{ type: 'text', text: '' }];
            }

            return [{ type: 'text', text: String(raw) }];
        }

        async function extractResponses(response) {
            const rawContentType = response.headers.get('content-type') || '';
            const contentType = rawContentType.toLowerCase();
            const disposition = response.headers.get('content-disposition') || '';
            const filenameSuggestsImage = /\.(png|jpe?g|gif|webp)/i.test(disposition);
            const isImage = contentType.startsWith('image/');
            const isBinary = contentType === 'application/octet-stream';

            if (isImage || isBinary || (!contentType && filenameSuggestsImage)) {
                const blob = await response.blob();
                const objectUrl = URL.createObjectURL(blob);
                return [{
                    type: 'image',
                    url: objectUrl,
                    caption: response.headers.get('x-caption') || ''
                }];
            }

            let payload;
            try {
                if (contentType.includes('application/json')) {
                    payload = await response.json();
                } else if (contentType.startsWith('text/') || contentType.includes('xml') || contentType.includes('html') || !contentType) {
                    const text = await response.text();
                    try {
                        payload = text ? JSON.parse(text) : '';
                    } catch {
                        payload = text;
                    }
                } else {
                    const blob = await response.blob();
                    const objectUrl = URL.createObjectURL(blob);
                    return [{
                        type: 'image',
                        url: objectUrl,
                        caption: response.headers.get('x-caption') || ''
                    }];
                }
            } catch (error) {
                console.error('Failed to parse response payload:', error);
                payload = '';
            }

            return normalizeResponse(payload);
        }

        function renderMessageContent(targetEl, payload) {
            if (!payload) {
                updateMessage(targetEl, 'پاسخی دریافت نشد');
                return;
            }

            if (payload.type === 'image' && payload.url) {
                updateMessage(targetEl, createImageContent(payload));
                return;
            }

            if (payload.type === 'location' && payload.latitude && payload.longitude) {
                updateMessage(targetEl, createLocationContent(payload));
                return;
            }

            updateMessage(targetEl, createTextContent(payload.text || 'پاسخی دریافت نشد'));
        }

        async function sendSearchQuery() {
            if (isSending) {
                return;
            }

            const query = searchInput.value.trim();

            if (!query) {
                return;
            }

            searchInput.value = '';

            // Generate unique requestId for this query to maintain chronological order
            const requestId = `req_${Date.now()}_${++requestIdCounter}`;
            
            const userMessageEl = appendMessage('user', query);
            userMessageEl.setAttribute('data-request-id', requestId);

            // Show pending message with micro-progress indicator
            const progressIndicator = createMicroProgressIndicator();
            const botPlaceholder = appendMessage('bot', progressIndicator, { isPending: true });
            botPlaceholder.setAttribute('data-request-id', requestId);
            setSearchState(true);

            const payload = {
                store: selectedStore,
                city: selectedCity,
                query,
                timestamp: new Date().toISOString()
            };
            
            // Update webhook URL based on selected city
            if (selectedCity) {
                WEBHOOK_URL = getWebhookUrlByCity(selectedCity);
            } else {
                WEBHOOK_URL = 'https://33140-nwo6p.s1.irann8n.com/webhook-test/bc6b217a-7c36-4532-830e-1a592ef03390';
            }

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                // Get raw response data first for store detection
                let rawResponseData = null;
                try {
                    const responseClone = response.clone();
                    rawResponseData = await responseClone.json().catch(() => null);
                } catch(e) {
                    // If response is not JSON, continue with extractResponses
                    console.error('Error reading raw response:', e);
                }

                const responses = await extractResponses(response);

                if (!response.ok) {
                    const message = responses[0]?.text || 'خطای ناشناخته';
                    throw new Error(message);
                }

                if (!responses.length) {
                    updateMessage(botPlaceholder, 'پاسخی دریافت نشد');
                } else {
                    // Check if no store is selected and response contains stores
                    if ((!selectedStore || selectedStore === '') && rawResponseData) {
                        let storesArray = null;
                        
                        // Check if rawResponseData is an array
                        if (Array.isArray(rawResponseData) && rawResponseData.length > 0) {
                            storesArray = rawResponseData;
                        } 
                        // Check if rawResponseData has a stores/items/results array
                        else if (typeof rawResponseData === 'object') {
                            storesArray = rawResponseData.stores || rawResponseData.items || rawResponseData.results || 
                                         rawResponseData.data || rawResponseData.list || null;
                        }
                        
                        // If we found a stores array, check if items look like stores
                        if (storesArray && Array.isArray(storesArray) && storesArray.length > 0) {
                            const firstItem = storesArray[0];
                            const hasImage = firstItem.image || firstItem.url || firstItem.image_url || firstItem.photo || firstItem.type === 'image';
                            const hasText = firstItem.text || firstItem.result || firstItem.نتیجه || firstItem.caption || firstItem.description;
                            
                            if (hasImage || hasText) {
                                // Store folder data for this requestId (for event delegation)
                                storeFolderDataMap.set(requestId, storesArray);
                                // Remove placeholder before displaying folders
                                botPlaceholder.remove();
                                // Display store folders using raw data to preserve all fields
                                displayStoreFolders(storesArray, requestId);
                            } else {
                                // Normal response handling
                    renderMessageContent(botPlaceholder, responses[0]);
                    if (responses.length > 1) {
                        responses.slice(1).forEach(item => {
                            const extraMessage = appendMessage('bot', '');
                            extraMessage.setAttribute('data-request-id', requestId);
                            renderMessageContent(extraMessage, item);
                        });
                                }
                            }
                        } else {
                            // Normal response handling
                            renderMessageContent(botPlaceholder, responses[0]);
                            if (responses.length > 1) {
                                responses.slice(1).forEach(item => {
                                    const extraMessage = appendMessage('bot', '');
                                    extraMessage.setAttribute('data-request-id', requestId);
                                    renderMessageContent(extraMessage, item);
                                });
                            }
                        }
                    } else {
                        // Normal response handling when store is selected
                        renderMessageContent(botPlaceholder, responses[0]);
                        if (responses.length > 1) {
                            responses.slice(1).forEach(item => {
                                const extraMessage = appendMessage('bot', '');
                                extraMessage.setAttribute('data-request-id', requestId);
                                renderMessageContent(extraMessage, item);
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('n8n webhook error:', error);
                updateMessage(botPlaceholder, 'خطا در دریافت پاسخ. لطفاً دوباره تلاش کنید.');
            } finally {
                setSearchState(false);
            }
        }

        // Search button click
        searchBtn.addEventListener('click', sendSearchQuery);

        // Enter key in search input
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendSearchQuery();
            }
        });

        // Display store folders when no store is selected
        // Process responses sequentially: store_name + نتیجه creates new folder, images go to current folder
        function displayStoreFolders(stores, requestId) {
            // Find the query element for this requestId to insert results right after it
            const queryElement = searchResults.querySelector(`[data-request-id="${requestId}"].message-user`);
            
            // Create container for store folders
            const foldersContainer = document.createElement('div');
            foldersContainer.className = 'store-folders-container';
            foldersContainer.setAttribute('data-request-id', requestId);
            
            let currentStore = null;
            const storesList = [];
            
            // Process items sequentially
            stores.forEach((item) => {
                // Check if this item has store_name - it means a new store starts
                if (item.store_name) {
                    // Save previous store if exists
                    if (currentStore) {
                        storesList.push(currentStore);
                    }
                    // Create new store folder
                    currentStore = {
                        store_name: item.store_name,
                        نتیجه: item.نتیجه || item.result || null,
                        store_info: item.store_info || item.storeInfo || item.info || null,
                        images: []
                    };
                } else if (currentStore) {
                    // This is an image for the current store
                    const imageUrl = item.image || item.url || item.image_url || item.photo || (item.type === 'image' ? item.url : '');
                    if (imageUrl) {
                        currentStore.images.push({
                            url: imageUrl,
                            info: item.info || item.text || item.caption || item.description || ''
                        });
                    }
                }
            });
            
            // Don't forget the last store
            if (currentStore) {
                storesList.push(currentStore);
            }
            
            // Create folders for each store
            storesList.forEach((storeGroup) => {
                const storeFolder = document.createElement('div');
                storeFolder.className = 'store-folder';
                
                // Use the first image as the folder preview
                const previewImage = storeGroup.images.length > 0 ? storeGroup.images[0].url : '';
                
                // Format نتیجه text: make numbers bigger, bold, green and fancy
                let formattedResult = '';
                if (storeGroup.نتیجه) {
                    // Match pattern: number followed by text (e.g., "4 مورد در جواهری مهران یافت شد")
                    formattedResult = storeGroup.نتیجه.replace(/(\d+)/g, '<span style="font-weight: bold; color: #22c55e; font-size: 1.3em; text-shadow: 0 2px 4px rgba(34, 197, 94, 0.3); display: inline-block; transform: scale(1.1);">$1</span>');
                }
                
                storeFolder.innerHTML = `
                    ${previewImage ? `<img src="${previewImage}" alt="${storeGroup.store_name}" class="store-folder-image" onerror="this.style.display='none';" />` : '<div class="store-folder-image" style="background: var(--gold-light); display: flex; align-items: center; justify-content: center; font-size: 48px;">📁</div>'}
                    <div class="store-folder-name">${storeGroup.store_name}</div>
                    ${formattedResult ? `<div class="store-folder-text">${formattedResult}</div>` : ''}
                `;
                
                // Store storeGroup data in data attribute for event delegation
                storeFolder.setAttribute('data-store-name', storeGroup.store_name || '');
                storeFolder.setAttribute('data-request-id', requestId);
                
                foldersContainer.appendChild(storeFolder);
            });
            
            // Insert folders container right after the query that triggered it (maintains chronological order)
            if (queryElement && queryElement.parentNode) {
                // Insert right after the query element
                if (queryElement.nextSibling) {
                    queryElement.parentNode.insertBefore(foldersContainer, queryElement.nextSibling);
                } else {
                    queryElement.parentNode.appendChild(foldersContainer);
                }
            } else {
                // Fallback: append to end if query not found
                searchResults.appendChild(foldersContainer);
            }
            
            // Clean up old items (keep last 5 searches = 10 items: 5 queries + 5 results)
            cleanupOldItems();
            
            scrollToBottom();
        }
        
        // Clean up old items while maintaining chronological order
        function cleanupOldItems() {
            const allItems = Array.from(searchResults.children);
            const requestIds = new Set();
            
            // Collect all requestIds from messages and folder containers
            allItems.forEach(item => {
                const requestId = item.getAttribute('data-request-id');
                if (requestId) {
                    requestIds.add(requestId);
                }
            });
            
            // Only cleanup if we have requestIds (new system)
            // For backward compatibility, if no requestIds exist, use old cleanup logic
            if (requestIds.size === 0) {
                // Old cleanup: keep last 10 messages, but never remove loading messages
                const allMessages = Array.from(searchResults.querySelectorAll('.message')).filter(msg => 
                    !msg.hasAttribute('data-loading-message')
                );
                if (allMessages.length > 10) {
                    const messagesToRemove = allMessages.length - 10;
                    for (let i = 0; i < messagesToRemove; i++) {
                        allMessages[i].remove();
                    }
                }
                return;
            }
            
            // Keep only last 5 requestIds (5 searches = 5 queries + 5 results)
            const requestIdArray = Array.from(requestIds).sort(); // Sort to maintain order
            if (requestIdArray.length > 5) {
                const idsToRemove = requestIdArray.slice(0, requestIdArray.length - 5);
                
                // Remove items with old requestIds (both messages and folder containers)
                // But never remove loading messages
                allItems.forEach(item => {
                    // Skip loading messages
                    if (item.hasAttribute('data-loading-message')) {
                        return;
                    }
                    const requestId = item.getAttribute('data-request-id');
                    if (requestId && idsToRemove.includes(requestId)) {
                        item.remove();
                        // Clean up store folder data
                        if (storeFolderDataMap.has(requestId)) {
                            storeFolderDataMap.delete(requestId);
                        }
                    }
                });
            }
        }
        
        // Show store detail page
        function showStoreDetailPage(storeGroup) {
            const storeName = storeGroup.store_name || 'فروشگاه';
            
            currentStoreData = {
                name: storeName,
                store_name: storeName, // Use store_name for address request
                images: storeGroup.images || [],
                allData: storeGroup
            };
            
            // Hide main content and show store detail page
            mainContentArea.style.display = 'none';
            document.querySelector('.search-bar').style.display = 'none';
            storeDetailPage.style.display = 'block';
            storeDetailPage.classList.add('show');
            backBtn.style.display = 'flex';
            
            // Set store name (ensure store_info is not included)
            storeDetailName.textContent = storeName;
            
            // Set store_info below store_name
            const storeInfo = storeGroup.store_info || storeGroup.storeInfo || null;
            if (storeInfo) {
                storeDetailInfo.textContent = storeInfo;
                storeDetailInfo.style.display = 'block';
            } else {
                storeDetailInfo.style.display = 'none';
            }
            
            // Hide address container initially
            storeDetailAddressContainer.style.display = 'none';
            
            // Clear and prepare products area
            storeDetailProducts.innerHTML = '';
            
            // Display all images with their info beneath each image
            // Filter out store_info from image captions (store_info should only appear in detail page header)
            if (storeGroup.images && storeGroup.images.length > 0) {
                storeGroup.images.forEach((imageData) => {
                    // Don't display store_info in image caption - it should only be in detail page header
                    let imageInfo = imageData.info || '';
                    if (storeInfo && imageInfo === storeInfo) {
                        imageInfo = '';
                    }
                    
                    const imageItem = document.createElement('div');
                    imageItem.className = 'delete-edit-image-item';
                    imageItem.innerHTML = `
                        <img src="${imageData.url}" alt="${storeName}" />
                        ${imageInfo ? `<div class="delete-edit-image-caption">${imageInfo}</div>` : ''}
                    `;
                    storeDetailProducts.appendChild(imageItem);
                });
            }
        }
        
        // Store detail back button
        if (storeDetailBackBtn) {
            storeDetailBackBtn.addEventListener('click', function() {
                storeDetailPage.classList.remove('show');
                storeDetailPage.style.display = 'none';
                mainContentArea.style.display = 'block';
                document.querySelector('.search-bar').style.display = 'flex';
                backBtn.style.display = 'none';
            });
        }
        
        // Store detail address button - fetches latitude and longitude from backend and opens Google Maps
        if (storeDetailAddressBtn) {
            storeDetailAddressBtn.addEventListener('click', async function() {
                if (!currentStoreData || !currentStoreData.store_name) {
                    alert('اطلاعات فروشگاه در دسترس نیست');
                    return;
                }
                
                storeDetailAddressBtn.disabled = true;
                const originalText = storeDetailAddressBtn.textContent;
                storeDetailAddressBtn.textContent = 'در حال بارگذاری...';
                
                try {
                    // Use the webhook URL based on selected city, or default
                    const addressWebhookUrl = selectedCity && cityData[selectedCity] 
                        ? cityData[selectedCity].webhookUrl 
                        : WEBHOOK_URL;
                    
                    const response = await fetch(addressWebhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'address',
                            store_name: currentStoreData.store_name,
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('خطا در دریافت آدرس');
                    }
                    
                    const responseData = await response.json();
                    
                    // Helper function to extract coordinates from various response structures
                    function extractCoordinates(data) {
                        // If data is an array, check first item
                        if (Array.isArray(data) && data.length > 0) {
                            return extractCoordinates(data[0]);
                        }
                        
                        // Check direct properties
                        if (data.latitude && data.longitude) {
                            return { latitude: data.latitude, longitude: data.longitude };
                        }
                        if (data.lat && data.lng) {
                            return { latitude: data.lat, longitude: data.lng };
                        }
                        if (data.lat && data.lon) {
                            return { latitude: data.lat, longitude: data.lon };
                        }
                        
                        // Check nested structures
                        if (data.data) {
                            const nested = extractCoordinates(data.data);
                            if (nested) return nested;
                        }
                        if (data.result) {
                            const nested = extractCoordinates(data.result);
                            if (nested) return nested;
                        }
                        if (data.response) {
                            const nested = extractCoordinates(data.response);
                            if (nested) return nested;
                        }
                        if (data.location) {
                            const nested = extractCoordinates(data.location);
                            if (nested) return nested;
                        }
                        
                        // Check common array keys
                        const arrayKeys = ['items', 'results', 'data', 'locations'];
                        for (const key of arrayKeys) {
                            if (Array.isArray(data[key]) && data[key].length > 0) {
                                const nested = extractCoordinates(data[key][0]);
                                if (nested) return nested;
                            }
                        }
                        
                        return null;
                    }
                    
                    // Helper function to extract address text from various response structures
                    function extractAddressText(data) {
                        // Check direct properties
                        if (data.ادرس) return data.ادرس;
                        if (data.address) return data.address;
                        if (data.text) return data.text;
                        
                        // Check nested structures
                        if (data.data) {
                            const nested = extractAddressText(data.data);
                            if (nested) return nested;
                        }
                        if (data.result) {
                            const nested = extractAddressText(data.result);
                            if (nested) return nested;
                        }
                        if (data.response) {
                            const nested = extractAddressText(data.response);
                            if (nested) return nested;
                        }
                        
                        // Check if data is an array
                        if (Array.isArray(data) && data.length > 0) {
                            return extractAddressText(data[0]);
                        }
                        
                        return null;
                    }
                    
                    const coords = extractCoordinates(responseData);
                    const addressText = extractAddressText(responseData);
                    
                    // Display address text if available
                    if (addressText) {
                        storeDetailAddressText.textContent = addressText;
                        storeDetailAddressContainer.style.display = 'block';
                    } else {
                        storeDetailAddressContainer.style.display = 'none';
                    }
                    
                    if (coords && coords.latitude && coords.longitude) {
                        // Validate coordinates are numbers
                        const lat = parseFloat(coords.latitude);
                        const lng = parseFloat(coords.longitude);
                        
                        if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                            // Create location content with Google Maps link
                            const locationContent = createLocationContent({
                                latitude: lat,
                                longitude: lng,
                                text: addressText || 'موقعیت فروشگاه'
                            });
                            storeDetailAddressLocation.innerHTML = '';
                            storeDetailAddressLocation.appendChild(locationContent);
                            
                        // Open Google Maps with coordinates from backend
                            openGoogleMaps(lat, lng);
                    } else {
                            alert('مختصات جغرافیایی نامعتبر است');
                        }
                    } else {
                        if (!addressText) {
                        alert('مختصات جغرافیایی در دسترس نیست');
                        }
                    }
                } catch (error) {
                    console.error('Address error:', error);
                    alert('خطا در دریافت آدرس. لطفاً دوباره تلاش کنید.');
                } finally {
                    storeDetailAddressBtn.disabled = false;
                    storeDetailAddressBtn.textContent = originalText;
                }
            });
        }

        // Address functionality (old - can be removed if not needed elsewhere)
        function showAddressLocation() {
            // Check if store is selected
            if (!selectedStore || selectedStore === '') {
                alert('ابتدا مغازه خود را انتخاب کنید.');
                return;
            }
            
            // Show modal
            addressModal.classList.add('show');
            modalAddress.textContent = 'در حال بارگذاری آدرس...';

            // Prepare data for n8n webhook
            const webhookData = {
                store: selectedStore,
                action: 'get_address',
                timestamp: new Date().toISOString()
            };

            // Log to console (simulating webhook call)
            console.log('Sending address request to n8n Webhook:', webhookData);
            console.log('POST URL: https://your-n8n-webhook-url.com/webhook/address');

            // Simulate API call delay
            setTimeout(() => {
                // Mock address data
                const mockAddress = {
                    text: 'تهران، خیابان ولیعصر، پلاک ۱۲۳، فروشگاه جواهری ستارزاده',
                    latitude: 35.6892,
                    longitude: 51.3890
                };

                modalAddress.textContent = mockAddress.text;
                
                // Store coordinates for map view
                viewMapBtn.onclick = function() {
                    openGoogleMaps(mockAddress.latitude, mockAddress.longitude);
                };
            }, 500);
        }

        function openGoogleMaps(lat, lng) {
            const url = `https://www.google.com/maps?q=${lat},${lng}`;
            window.open(url, '_blank');
        }

        // Address button click

        // Modal close functionality
        closeModalBtn.addEventListener('click', function() {
            addressModal.classList.remove('show');
        });

        // Close modal when clicking outside
        addressModal.addEventListener('click', function(e) {
            if (e.target === addressModal) {
                addressModal.classList.remove('show');
            }
        });

        // Menu button click - toggle accordion
        menuBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            accordionMenu.classList.toggle('show');
        });

        // Close accordion when clicking outside
        document.addEventListener('click', function(e) {
            if (!menuBtn.contains(e.target) && !accordionMenu.contains(e.target)) {
                accordionMenu.classList.remove('show');
            }
        });

        // Accordion menu item clicks
        contactMenuItem.addEventListener('click', function() {
            accordionMenu.classList.remove('show');
            contactModal.classList.add('show');
        });

        loginMenuItem.addEventListener('click', function() {
            accordionMenu.classList.remove('show');
            loginModal.classList.add('show');
        });

        goldPriceMenuItem.addEventListener('click', async function() {
            accordionMenu.classList.remove('show');
            goldPriceModal.classList.add('show');
            goldPriceContainer.innerHTML = '<div class="loading">در حال بارگذاری...</div>';
            
            try {
                const response = await fetch('https://33140-nwo6p.s1.irann8n.com/webhook/5906c811-a199-49c6-bd96-1f2e1cdf6e53', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'get_gold_prices',
                        username: 'users',
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch gold prices');
                }
                
                const data = await response.json();
                displayGoldPrices(data);
            } catch (error) {
                console.error('Gold price error:', error);
                goldPriceContainer.innerHTML = '<div class="loading" style="color: #ff3b30;">خطا در دریافت قیمت‌ها. لطفاً دوباره تلاش کنید.</div>';
            }
        });

        // Contact form submission
        contactForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('contactName').value.trim();
            const phone = document.getElementById('contactPhone').value.trim();
            const text = document.getElementById('contactText').value.trim();

            if (!name || !phone || !text) {
                alert('لطفاً تمام فیلدها را پر کنید');
                return;
            }

            contactSubmitBtn.disabled = true;
            contactSubmitBtn.textContent = 'در حال ارسال...';

            try {
                const response = await fetch(CONTACT_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'contact',
                        name: name,
                        phone: phone,
                        text: text,
                        timestamp: new Date().toISOString()
                    })
                });

                if (response.ok) {
                    alert('پیام شما با موفقیت ارسال شد');
                    contactForm.reset();
                    contactModal.classList.remove('show');
                } else {
                    alert('خطا در ارسال پیام. لطفاً دوباره تلاش کنید.');
                }
            } catch (error) {
                console.error('Contact form error:', error);
                alert('خطا در ارسال پیام. لطفاً دوباره تلاش کنید.');
            } finally {
                contactSubmitBtn.disabled = false;
                contactSubmitBtn.textContent = 'ارسال';
            }
        });

        // Login form submission
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!username || !password) {
                alert('لطفاً نام کاربری و رمز عبور را وارد کنید');
                return;
            }

            loginSubmitBtn.disabled = true;
            loginSubmitBtn.textContent = 'در حال ورود...';

            try {
                const response = await fetch(LOGIN_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'login',
                        username: username,
                        password: password,
                        timestamp: new Date().toISOString()
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.token) {
                    // Store the token and username
                    setToken(data.token);
                    setUsername(username);
                    loginForm.reset();
                    loginModal.classList.remove('show');
                    // Show admin dashboard and hide main content
                    mainContentArea.style.display = 'none';
                    document.querySelector('.search-bar').style.display = 'none';
                    mainHeader.classList.add('header-admin-mode');
                    adminDashboard.classList.add('show');
                } else {
                    alert(data.message || 'نام کاربری یا رمز عبور اشتباه است');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('خطا در ورود. لطفاً دوباره تلاش کنید.');
            } finally {
                loginSubmitBtn.disabled = false;
                loginSubmitBtn.textContent = 'ورود';
            }
        });

        // Back button handler
        backBtn.addEventListener('click', function() {
            // If on add page, go back to admin dashboard
            if (addPage && (addPage.style.display === 'block' || addPage.classList.contains('show'))) {
                addPage.classList.remove('show');
                addPage.style.display = 'none';
                adminDashboard.classList.add('show');
                backBtn.style.display = 'none';
                return;
            }
            
            // If on delete/edit page, go back to admin dashboard
            if (deleteEditPage && (deleteEditPage.style.display === 'block' || deleteEditPage.classList.contains('show'))) {
                deleteEditPage.classList.remove('show');
                deleteEditPage.style.display = 'none';
                adminDashboard.classList.add('show');
                backBtn.style.display = 'none';
                return;
            }
            
            // Otherwise, clear token and go back to main page
            clearToken();
            mainHeader.classList.remove('header-admin-mode');
            adminDashboard.classList.remove('show');
            mainContentArea.style.display = 'block';
            document.querySelector('.search-bar').style.display = 'flex';
            
            // Clear search results (images from "10 محصول آخر")
            searchResults.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🔍</div><div>برای جستجو، ابتدا شهر سپس نوع طلا، قیمت و ... را در پایین وارد کنید</div></div>';
        });

        // Fetch gold prices
        async function fetchGoldPrices() {
            goldPriceContainer.innerHTML = '<div class="loading">در حال بارگذاری...</div>';

            try {
                const response = await fetch(GOLD_PRICE_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'get_gold_prices',
                        timestamp: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch gold prices');
                }

                const data = await response.json();
                displayGoldPrices(data);
            } catch (error) {
                console.error('Gold price error:', error);
                goldPriceContainer.innerHTML = '<div class="loading" style="color: #ff3b30;">خطا در دریافت قیمت‌ها. لطفاً دوباره تلاش کنید.</div>';
            }
        }

        // Display gold prices
        function displayGoldPrices(data) {
            if (!data || typeof data !== 'object') {
                goldPriceContainer.innerHTML = '<div class="loading">اطلاعاتی دریافت نشد</div>';
                return;
            }

            let html = '';
            
            // If data is an array
            if (Array.isArray(data)) {
                data.forEach(item => {
                    if (typeof item === 'object') {
                        Object.entries(item).forEach(([key, value]) => {
                            html += `
                                <div class="gold-price-item">
                                    <span class="gold-price-label">${key}</span>
                                    <span class="gold-price-value">${value}</span>
                                </div>
                            `;
                        });
                    }
                });
            } else {
                // If data is an object
                Object.entries(data).forEach(([key, value]) => {
                    if (typeof value === 'object' && value !== null) {
                        html += `
                            <div class="gold-price-item" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                                <span class="gold-price-label" style="font-size: 16px; font-weight: 600;">${key}</span>
                        `;
                        Object.entries(value).forEach(([subKey, subValue]) => {
                            html += `
                                <div style="display: flex; justify-content: space-between; width: 100%; padding-right: 16px;">
                                    <span class="gold-price-label">${subKey}</span>
                                    <span class="gold-price-value">${subValue}</span>
                                </div>
                            `;
                        });
                        html += `</div>`;
                    } else {
                        html += `
                            <div class="gold-price-item">
                                <span class="gold-price-label">${key}</span>
                                <span class="gold-price-value">${value}</span>
                            </div>
                        `;
                    }
                });
            }

            goldPriceContainer.innerHTML = html || '<div class="loading">اطلاعاتی دریافت نشد</div>';
        }

        // Close modals
        closeContactModalBtn.addEventListener('click', function() {
            contactModal.classList.remove('show');
        });

        closeLoginModalBtn.addEventListener('click', function() {
            loginModal.classList.remove('show');
        });

        closeGoldPriceModalBtn.addEventListener('click', function() {
            goldPriceModal.classList.remove('show');
        });

        closePasswordResetModalBtn.addEventListener('click', function() {
            passwordResetModal.classList.remove('show');
        });

        closeStoreSetupModalBtn.addEventListener('click', function() {
            storeSetupModal.classList.remove('show');
        });

        // Password reset button click
        passwordResetBtn.addEventListener('click', function() {
            loginModal.classList.remove('show');
            passwordResetModal.classList.add('show');
        });

        // Password reset form submission
        passwordResetForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const phone = document.getElementById('passwordResetPhone').value.trim();

            if (!phone) {
                alert('لطفاً شماره تماس را وارد کنید');
                return;
            }

            passwordResetSubmitBtn.disabled = true;
            passwordResetSubmitBtn.textContent = 'در حال ارسال...';

            try {
                const response = await fetch(LOGIN_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'reset_password',
                        phone: phone,
                        timestamp: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error('خطا در ارسال اطلاعات');
                }

                const data = await response.json();
                if (response.ok) {
                    // Check if response contains "login/setting_pass" to redirect to store setup
                    const responseText = JSON.stringify(data).toLowerCase();
                    const nextPage = data.nextPage || data.nextpage || '';
                    
                    if (nextPage === 'login/setting_pass' || responseText.includes('login/setting_pass') || responseText.includes('setting_pass')) {
                        passwordResetModal.classList.remove('show');
                        storeSetupModal.classList.add('show');
                        // Pre-fill mobile number in the correct field
                        document.getElementById('storeSetupMobile').value = phone;
                    } else {
                        alert('اطلاعات با موفقیت ارسال شد');
                        passwordResetForm.reset();
                        passwordResetModal.classList.remove('show');
                    }
                }
            } catch (error) {
                console.error('Password reset error:', error);
                alert('خطا در ارسال اطلاعات. لطفاً دوباره تلاش کنید.');
            } finally {
                passwordResetSubmitBtn.disabled = false;
                passwordResetSubmitBtn.textContent = 'ارسال';
            }
        });

        // Store location data
        let storeLocationData = null;
        let map = null;
        let marker = null;
        let selectedLocation = null;

        // Initialize Google Maps when location picker modal opens
        function initLocationPicker() {
            if (typeof google === 'undefined' || !google.maps) {
                alert('خطا در بارگذاری نقشه. لطفاً صفحه را رفرش کنید یا API key را بررسی کنید.');
                locationPickerModal.classList.remove('show');
                return;
            }
            
            if (!map) {
                // Default to Tehran, Iran
                const defaultLocation = { lat: 35.6892, lng: 51.3890 };
                
                map = new google.maps.Map(document.getElementById('map'), {
                    center: defaultLocation,
                    zoom: 13,
                    mapTypeControl: true,
                    streetViewControl: true,
                    fullscreenControl: true
                });

                // Try to get user's current location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            map.setCenter(userLocation);
                            map.setZoom(15);
                            
                            // Add initial marker
                            marker = new google.maps.Marker({
                                position: userLocation,
                                map: map,
                                draggable: true,
                                title: 'موقعیت شما'
                            });
                            
                            selectedLocation = userLocation;
                            updateLocationInfo(userLocation);
                            
                            // Add click listener to map
                            map.addListener('click', function(e) {
                                const clickedLocation = {
                                    lat: e.latLng.lat(),
                                    lng: e.latLng.lng()
                                };
                                
                                if (marker) {
                                    marker.setPosition(clickedLocation);
                                } else {
                                    marker = new google.maps.Marker({
                                        position: clickedLocation,
                                        map: map,
                                        draggable: true
                                    });
                                }
                                
                                selectedLocation = clickedLocation;
                                updateLocationInfo(clickedLocation);
                            });
                            
                            // Update location when marker is dragged
                            marker.addListener('dragend', function(e) {
                                const draggedLocation = {
                                    lat: e.latLng.lat(),
                                    lng: e.latLng.lng()
                                };
                                selectedLocation = draggedLocation;
                                updateLocationInfo(draggedLocation);
                            });
                        },
                        function(error) {
                            // If geolocation fails, use default location
                            marker = new google.maps.Marker({
                                position: defaultLocation,
                                map: map,
                                draggable: true
                            });
                            
                            selectedLocation = defaultLocation;
                            updateLocationInfo(defaultLocation);
                            
                            // Add click listener to map
                            map.addListener('click', function(e) {
                                const clickedLocation = {
                                    lat: e.latLng.lat(),
                                    lng: e.latLng.lng()
                                };
                                
                                if (marker) {
                                    marker.setPosition(clickedLocation);
                                } else {
                                    marker = new google.maps.Marker({
                                        position: clickedLocation,
                                        map: map,
                                        draggable: true
                                    });
                                }
                                
                                selectedLocation = clickedLocation;
                                updateLocationInfo(clickedLocation);
                            });
                            
                            // Update location when marker is dragged
                            marker.addListener('dragend', function(e) {
                                const draggedLocation = {
                                    lat: e.latLng.lat(),
                                    lng: e.latLng.lng()
                                };
                                selectedLocation = draggedLocation;
                                updateLocationInfo(draggedLocation);
                            });
                        }
                    );
                } else {
                    // Fallback if geolocation is not available
                    marker = new google.maps.Marker({
                        position: defaultLocation,
                        map: map,
                        draggable: true
                    });
                    
                    selectedLocation = defaultLocation;
                    updateLocationInfo(defaultLocation);
                    
                    // Add click listener to map
                    map.addListener('click', function(e) {
                        const clickedLocation = {
                            lat: e.latLng.lat(),
                            lng: e.latLng.lng()
                        };
                        
                        if (marker) {
                            marker.setPosition(clickedLocation);
                        } else {
                            marker = new google.maps.Marker({
                                position: clickedLocation,
                                map: map,
                                draggable: true
                            });
                        }
                        
                        selectedLocation = clickedLocation;
                        updateLocationInfo(clickedLocation);
                    });
                    
                    // Update location when marker is dragged
                    marker.addListener('dragend', function(e) {
                        const draggedLocation = {
                            lat: e.latLng.lat(),
                            lng: e.latLng.lng()
                        };
                        selectedLocation = draggedLocation;
                        updateLocationInfo(draggedLocation);
                    });
                }
            }
        }

        function updateLocationInfo(location) {
            selectedLocationText.textContent = `عرض جغرافیایی: ${location.lat.toFixed(6)}, طول جغرافیایی: ${location.lng.toFixed(6)}`;
            selectedLocationInfo.style.display = 'block';
        }

        // Store setup location button - opens Google Maps picker
        storeSetupLocationBtn.addEventListener('click', function() {
            locationPickerModal.classList.add('show');
            // Initialize map when modal opens - wait for Google Maps API to load
            function tryInitMap() {
                if (typeof google !== 'undefined' && google.maps) {
                    initLocationPicker();
                } else {
                    setTimeout(tryInitMap, 100);
                }
            }
            tryInitMap();
        });

        // Close location picker modal
        closeLocationPickerModalBtn.addEventListener('click', function() {
            locationPickerModal.classList.remove('show');
        });

        // Confirm location button
        confirmLocationBtn.addEventListener('click', function() {
            if (selectedLocation) {
                storeLocationData = {
                    latitude: selectedLocation.lat,
                    longitude: selectedLocation.lng
                };
                storeSetupLocationText.textContent = `موقعیت: ${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
                storeSetupLocationDisplay.style.display = 'block';
                locationPickerModal.classList.remove('show');
            } else {
                alert('لطفاً موقعیت را روی نقشه انتخاب کنید');
            }
        });

        // Close location picker when clicking outside
        locationPickerModal.addEventListener('click', function(e) {
            if (e.target === locationPickerModal) {
                locationPickerModal.classList.remove('show');
            }
        });

        // Store setup form submission
        storeSetupForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('storeSetupUsername').value.trim();
            const password = document.getElementById('storeSetupPassword').value.trim();
            const mobile = document.getElementById('storeSetupMobile').value.trim();
            const code = document.getElementById('storeSetupCode').value.trim();
            const storeName = document.getElementById('storeSetupName').value.trim();
            const storePhone = document.getElementById('storeSetupPhone').value.trim();
            const storeAddress = document.getElementById('storeSetupAddress').value.trim();

            if (!username || !password || !mobile || !code || !storeName || !storePhone || !storeAddress) {
                alert('لطفاً تمام فیلدها را پر کنید');
                return;
            }

            if (code.length !== 5) {
                alert('کد باید 5 رقمی باشد');
                return;
            }

            storeSetupSubmitBtn.disabled = true;
            storeSetupSubmitBtn.textContent = 'در حال ارسال...';

            try {
                const response = await fetch(LOGIN_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'store_setup',
                        username: username,
                        password: password,
                        mobile: mobile,
                        code: code,
                        storeName: storeName,
                        storePhone: storePhone,
                        storeAddress: storeAddress,
                        location: storeLocationData,
                        timestamp: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error('خطا در ارسال اطلاعات');
                }

                const data = await response.json();
                if (response.ok) {
                    // Get nextPage value first (before closing modal)
                    const nextPage = data.nextPage || data.nextpage || '';
                    // Also check if response text contains login/setting_pass
                    const responseText = JSON.stringify(data).toLowerCase();
                    const hasSettingPass = nextPage === 'login/setting_pass' || nextPage === 'login/setting_pass/' || 
                                          responseText.includes('login/setting_pass') || responseText.includes('setting_pass');
                    
                    // Show message from backend if available
                    const message = data.message || 'اطلاعات با موفقیت ارسال شد';
                    alert(message);
                    
                    // Handle nextPage redirect
                    if (nextPage || hasSettingPass) {
                        if (hasSettingPass) {
                            // Stay on login/setting_pass page (store setup modal)
                            // Keep the modal open, reset form for new entry
                            storeSetupForm.reset();
                            storeSetupLocationDisplay.style.display = 'none';
                            storeLocationData = null;
                            storeSetupModal.classList.add('show'); // Ensure it's visible
                        } else if (nextPage === 'login' || nextPage === 'login/') {
                            // Redirect to login page
                            storeSetupForm.reset();
                            storeSetupLocationDisplay.style.display = 'none';
                            storeLocationData = null;
                            storeSetupModal.classList.remove('show');
                            mainHeader.classList.remove('header-admin-mode');
                            adminDashboard.classList.remove('show');
                            mainContentArea.style.display = 'block';
                            document.querySelector('.search-bar').style.display = 'flex';
                            loginModal.classList.add('show');
                        } else if (nextPage === 'home' || nextPage === 'home/') {
                            // Redirect to home page
                            storeSetupForm.reset();
                            storeSetupLocationDisplay.style.display = 'none';
                            storeLocationData = null;
                            storeSetupModal.classList.remove('show');
                            mainHeader.classList.remove('header-admin-mode');
                            adminDashboard.classList.remove('show');
                            mainContentArea.style.display = 'block';
                            document.querySelector('.search-bar').style.display = 'flex';
                            loginModal.classList.remove('show');
                        } else {
                            // For other nextPage values
                            console.log('nextPage value:', nextPage);
                            // Default: close modal and show home page
                            storeSetupForm.reset();
                            storeSetupLocationDisplay.style.display = 'none';
                            storeLocationData = null;
                            storeSetupModal.classList.remove('show');
                            mainHeader.classList.remove('header-admin-mode');
                            adminDashboard.classList.remove('show');
                            mainContentArea.style.display = 'block';
                            document.querySelector('.search-bar').style.display = 'flex';
                        }
                    } else {
                        // If no nextPage specified, default: close modal and show home
                        storeSetupForm.reset();
                        storeSetupLocationDisplay.style.display = 'none';
                        storeLocationData = null;
                        storeSetupModal.classList.remove('show');
                        mainContentArea.style.display = 'block';
                        document.querySelector('.search-bar').style.display = 'flex';
                    }
                }
            } catch (error) {
                console.error('Store setup error:', error);
                alert('خطا در ارسال اطلاعات. لطفاً دوباره تلاش کنید.');
            } finally {
                storeSetupSubmitBtn.disabled = false;
                storeSetupSubmitBtn.textContent = 'ارسال';
            }
        });

        // Close modals when clicking outside
        contactModal.addEventListener('click', function(e) {
            if (e.target === contactModal) {
                contactModal.classList.remove('show');
            }
        });

        loginModal.addEventListener('click', function(e) {
            if (e.target === loginModal) {
                loginModal.classList.remove('show');
            }
        });

        passwordResetModal.addEventListener('click', function(e) {
            if (e.target === passwordResetModal) {
                passwordResetModal.classList.remove('show');
            }
        });

        storeSetupModal.addEventListener('click', function(e) {
            if (e.target === storeSetupModal) {
                storeSetupModal.classList.remove('show');
            }
        });

        goldPriceModal.addEventListener('click', function(e) {
            if (e.target === goldPriceModal) {
                goldPriceModal.classList.remove('show');
            }
        });

        // Admin Dashboard Button Handlers
        headerSupportBtn.addEventListener('click', function() {
            supportModal.classList.add('show');
        });

        if (headerProductsBtn) {
        headerProductsBtn.addEventListener('click', async function() {
            // 10 محصول آخر - trigger webhook and display images
            if (!requireAuth()) return;
                
                let loadingMessage = null;
            
            try {
                const token = getToken();
                const username = getUsername();
                
                if (!token) {
                    alert('لطفاً ابتدا وارد شوید');
                    return;
                }
                
                    // Show loading state - ensure main content area is visible
                    mainContentArea.style.display = 'block';
                clearEmptyState();
                    loadingMessage = appendMessage('bot', 'در حال بررسی ...', { isPending: true });
                    
                    // Mark this message so it doesn't get cleaned up
                    if (loadingMessage) {
                        loadingMessage.setAttribute('data-loading-message', 'true');
                    }
                    
                    // Force browser to render the loading message before starting fetch
                    // This ensures the message is visible to the user
                    await new Promise(resolve => {
                        // Force a reflow to ensure the message is rendered
                        if (loadingMessage) {
                            void loadingMessage.offsetHeight;
                        }
                        scrollToBottom();
                        setTimeout(resolve, 150);
                    });
                    
                    const response = await fetch('https://33140-nwo6p.s1.irann8n.com/webhook/0bb445e1-3e17-4af3-b6f5-668723e9a53c', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'last_products',
                        token: token,
                        username: username,
                        timestamp: new Date().toISOString()
                    })
                });
                
                    if (!response.ok) {
                        // Remove loading message before handling error
                if (loadingMessage) {
                    loadingMessage.remove();
                            loadingMessage = null;
                }
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.message && (errorData.message.includes('token') || errorData.message.includes('unauthorized'))) {
                        clearToken();
                        requireAuth();
                        return;
                    }
                    throw new Error('خطا در دریافت اطلاعات');
                }
                
                const data = await response.json();
                
                // Display images with text beneath each image
                if (data && Array.isArray(data) && data.length > 0) {
                    // If response is an array of images
                    data.forEach(item => {
                        const imageUrl = item.url || item.image || item.image_url || item.photo || item.src;
                        const caption = item.caption || item.text || item.info || item.title || item.name || item.description || '';
                        
                        if (imageUrl) {
                            const imageContent = createImageContent({ url: imageUrl, caption: caption });
                            appendMessage('bot', imageContent);
                        }
                    });
                } else if (data.items && Array.isArray(data.items)) {
                    // If response has items array
                    data.items.forEach(item => {
                        const imageUrl = item.url || item.image || item.image_url || item.photo || item.src;
                        const caption = item.caption || item.text || item.info || item.title || item.name || item.description || '';
                        
                        if (imageUrl) {
                            const imageContent = createImageContent({ url: imageUrl, caption: caption });
                            appendMessage('bot', imageContent);
                        }
                    });
                } else if (data.images && Array.isArray(data.images)) {
                    // If response has images array
                    data.images.forEach(item => {
                        const imageUrl = item.url || item.image || item.image_url || item.photo || item.src;
                        const caption = item.caption || item.text || item.info || item.title || item.name || item.description || '';
                        
                        if (imageUrl) {
                            const imageContent = createImageContent({ url: imageUrl, caption: caption });
                            appendMessage('bot', imageContent);
                        }
                    });
                } else if (data.url || data.image || data.image_url || data.photo) {
                    // Single image response
                    const imageUrl = data.url || data.image || data.image_url || data.photo;
                    const caption = data.caption || data.text || data.info || data.title || data.name || data.description || '';
                    const imageContent = createImageContent({ url: imageUrl, caption: caption });
                    appendMessage('bot', imageContent);
                } else {
                    // No images found
                    appendMessage('bot', 'محصولی یافت نشد.');
                }
                
                // Remove loading message after displaying all images
                if (loadingMessage) {
                    loadingMessage.remove();
                    loadingMessage = null;
                }
                
                // Ensure main content area is visible
                mainContentArea.style.display = 'block';
                
            } catch (error) {
                console.error('Last products error:', error);
                // Remove loading message if it still exists
                if (loadingMessage) {
                    loadingMessage.remove();
                    loadingMessage = null;
                }
                appendMessage('bot', 'خطا در دریافت اطلاعات. لطفاً دوباره تلاش کنید.');
            }
        });
        } else {
            console.error('headerProductsBtn not found');
        }

        updatePricesBtn.addEventListener('click', async function() {
            // آپدیت قیمت ها - trigger webhook
            if (!requireAuth()) return;
            
            try {
                const token = getToken();
                const username = getUsername();
                
                if (!token) {
                    alert('لطفاً ابتدا وارد شوید');
                    return;
                }
                
                const response = await fetch('https://33140-nwo6p.s1.irann8n.com/webhook/5906c811-a199-49c6-bd96-1f2e1cdf6e53', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'update_prices',
                        token: token,
                        username: username,
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.message && (errorData.message.includes('token') || errorData.message.includes('unauthorized'))) {
                        clearToken();
                        requireAuth();
                        return;
                    }
                    throw new Error('خطا در به‌روزرسانی قیمت‌ها');
                }
                
                const data = await response.json();
                if (response.ok) {
                    // Check nextPage value from response
                    if (data.nextPage) {
                        if (data.nextPage === 'login') {
                            // Redirect to login page
                            clearToken();
                            mainHeader.classList.remove('header-admin-mode');
                            adminDashboard.classList.remove('show');
                            mainContentArea.style.display = 'block';
                            document.querySelector('.search-bar').style.display = 'flex';
                            loginModal.classList.add('show');
                            alert('لطفاً دوباره وارد شوید');
                        } else if (data.nextPage === 'home') {
                            // Stay on home page (already there)
                    alert('قیمت‌ها با موفقیت به‌روزرسانی شدند');
                        }
                    } else {
                        // No nextPage specified, show success message
                        alert('قیمت‌ها با موفقیت به‌روزرسانی شدند');
                    }
                }
            } catch (error) {
                console.error('Update prices error:', error);
                alert('خطا در به‌روزرسانی قیمت‌ها');
            }
        });

        deleteEditBtn.addEventListener('click', async function() {
            // حذف یا ادیت - trigger webhook and check response
            if (!requireAuth()) return;
            
            try {
                const token = getToken();
                const username = getUsername();
                
                if (!token) {
                    alert('لطفاً ابتدا وارد شوید');
                    return;
                }
                
                const response = await fetch(PAGE_NAVIGATION_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'delete_edit',
                        token: token,
                        username: username,
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.message && (errorData.message.includes('token') || errorData.message.includes('unauthorized'))) {
                        clearToken();
                        requireAuth();
                        return;
                    }
                    throw new Error('خطا در ارتباط با سرور');
                }
                
                const data = await response.json();
                const nextpage = data.nextpage || data.nextPage || '';
                
                if (nextpage === 'admin/delete_edit') {
                    adminDashboard.classList.remove('show');
                    deleteEditPage.classList.add('show');
                    deleteEditPage.style.display = 'block';
                    backBtn.style.display = 'flex';
                } else if (nextpage === 'login') {
                    clearToken();
                    requireAuth();
                } else if (nextpage === 'Home') {
                    adminDashboard.classList.remove('show');
                    mainHeader.classList.remove('header-admin-mode');
                    mainContentArea.style.display = 'block';
                    document.querySelector('.search-bar').style.display = 'flex';
                }
            } catch (error) {
                console.error('Delete/Edit error:', error);
                alert('خطا در ارتباط با سرور');
            }
        });

        addBtn.addEventListener('click', async function() {
            // افزودن - trigger webhook and check response
            if (!requireAuth()) return;
            
            try {
                const token = getToken();
                const username = getUsername();
                
                if (!token) {
                    alert('لطفاً ابتدا وارد شوید');
                    return;
                }
                
                const response = await fetch(PAGE_NAVIGATION_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'add',
                        token: token,
                        username: username,
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.message && (errorData.message.includes('token') || errorData.message.includes('unauthorized'))) {
                        clearToken();
                        requireAuth();
                        return;
                    }
                    throw new Error('خطا در ارتباط با سرور');
                }
                
                const data = await response.json();
                const nextpage = data.nextpage || data.nextPage || '';
                
                if (nextpage === 'admin/add') {
                    adminDashboard.classList.remove('show');
                    addPage.classList.add('show');
                    addPage.style.display = 'block';
                    backBtn.style.display = 'flex';
                    
                    // Fill the form with data from response
                    const goldCodeInput = document.getElementById('goldCode');
                    const productDescriptionInput = document.getElementById('productDescription');
                    
                    if (goldCodeInput && data.code) {
                        goldCodeInput.value = data.code;
                    }
                    if (productDescriptionInput && data.text) {
                        productDescriptionInput.value = data.text;
                    }
                    
                    // Fill the image if provided
                    if (data.image || data.image_url || data.url || data.photo) {
                        const imageUrl = data.image || data.image_url || data.url || data.photo;
                        if (imagePreview) {
                            const img = document.createElement('img');
                            img.src = imageUrl;
                            img.alt = 'Preview';
                            imagePreview.innerHTML = '';
                            imagePreview.appendChild(img);
                        }
                    }
                } else if (nextpage === 'login') {
                    clearToken();
                    requireAuth();
                } else if (nextpage === 'home' || nextpage === 'Home') {
                    adminDashboard.classList.remove('show');
                    mainHeader.classList.remove('header-admin-mode');
                    mainContentArea.style.display = 'block';
                    document.querySelector('.search-bar').style.display = 'flex';
                    backBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Add error:', error);
                alert('خطا در ارتباط با سرور');
            }
        });

        // Support form submission
        supportForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!requireAuth()) return;
            
            const text = document.getElementById('supportText').value.trim();
            const number = document.getElementById('supportNumber').value.trim();

            if (!text || !number) {
                alert('لطفاً تمام فیلدها را پر کنید');
                return;
            }

            supportSubmitBtn.disabled = true;
            supportSubmitBtn.textContent = 'در حال ارسال...';

            try {
                const token = getToken();
                const username = getUsername();
                
                if (!token) {
                    alert('لطفاً ابتدا وارد شوید');
                    supportSubmitBtn.disabled = false;
                    supportSubmitBtn.textContent = 'ارسال';
                    return;
                }
                
                const response = await fetch(ADMIN_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'support',
                        token: token,
                        username: username,
                        text: text,
                        number: number,
                        timestamp: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.message && (errorData.message.includes('token') || errorData.message.includes('unauthorized'))) {
                        clearToken();
                        requireAuth();
                        return;
                    }
                    throw new Error('خطا در ارسال پیام');
                }

                const data = await response.json();
                if (response.ok) {
                    alert('پیام شما با موفقیت ارسال شد');
                    supportForm.reset();
                    supportModal.classList.remove('show');
                }
            } catch (error) {
                console.error('Support form error:', error);
                alert('خطا در ارسال پیام. لطفاً دوباره تلاش کنید.');
            } finally {
                supportSubmitBtn.disabled = false;
                supportSubmitBtn.textContent = 'ارسال';
            }
        });

        // Close support modal
        closeSupportModalBtn.addEventListener('click', function() {
            supportModal.classList.remove('show');
        });

        supportModal.addEventListener('click', function(e) {
            if (e.target === supportModal) {
                supportModal.classList.remove('show');
            }
        });

        // Close colored pages
        closeGreenPageBtn.addEventListener('click', function() {
            greenPage.classList.remove('show');
        });

        closeRedPageBtn.addEventListener('click', function() {
            redPage.classList.remove('show');
        });

        // Image upload preview functionality
        if (imagePreview && imageInput) {
            // Click on preview area to trigger file input
            imagePreview.addEventListener('click', function() {
                imageInput.click();
            });

            // Handle file selection
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview" />`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.innerHTML = `
                        <div class="image-upload-placeholder">
                            <span class="upload-icon">📎</span>
                            <span class="upload-text">بارگذاری تصویر</span>
                        </div>
                    `;
                }
            });
        }

        // Add form submission
        if (addForm) {
            addForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!requireAuth()) return;
                
                const goldCode = document.getElementById('goldCode').value.trim();
                const productDescription = document.getElementById('productDescription').value.trim();
                const imageFile = imageInput ? imageInput.files[0] : null;

                if (!productDescription) {
                    alert('لطفاً توضیحات محصول را وارد کنید');
                    return;
                }

                addSubmitBtn.disabled = true;
                addSubmitBtn.innerHTML = '<span class="send-icon">⏳</span>';

                try {
                    const token = getToken();
                    const username = getUsername();
                    
                    if (!token) {
                        alert('لطفاً ابتدا وارد شوید');
                        addSubmitBtn.disabled = false;
                        addSubmitBtn.innerHTML = '<span class="send-icon">↑</span>';
                        return;
                    }
                    
                    // Convert image to base64 if present
                    let imageBase64 = null;
                    if (imageFile) {
                        imageBase64 = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(imageFile);
                        });
                    }

                    const response = await fetch(ADMIN_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'add_product',
                            token: token,
                            username: username,
                            goldCode: goldCode || null,
                            productDescription: productDescription,
                            image: imageBase64,
                            timestamp: new Date().toISOString()
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        if (errorData.message && (errorData.message.includes('token') || errorData.message.includes('unauthorized'))) {
                            clearToken();
                            requireAuth();
                            return;
                        }
                        throw new Error(errorData.message || 'خطا در ارسال اطلاعات');
                    }

                    const data = await response.json();
                    if (response.ok) {
                        // Show success checkmark animation
                        showSuccessCheckmark();
                        
                        // Show message from backend if available
                        const message = data.message || '';
                        if (message) {
                            // Delay alert slightly to let checkmark appear first
                            setTimeout(function() {
                            alert(message);
                            }, 300);
                        }
                        
                        addForm.reset();
                        if (imagePreview) {
                            imagePreview.innerHTML = `
                                <div class="image-upload-placeholder">
                                    <span class="upload-icon">📎</span>
                                    <span class="upload-text">بارگذاری تصویر</span>
                                </div>
                            `;
                        }
                        
                        // Check for nextpage in response
                        const nextpage = data.nextpage || data.nextPage || '';
                        
                        if (nextpage === 'admin/add') {
                            // Stay on add page - don't navigate away
                            // Form is already reset above, user can add more items
                        } else if (nextpage === 'login') {
                            clearToken();
                            requireAuth();
                            addPage.classList.remove('show');
                            addPage.style.display = 'none';
                        } else if (nextpage === 'Home' || nextpage === 'home') {
                            addPage.classList.remove('show');
                            addPage.style.display = 'none';
                            adminDashboard.classList.remove('show');
                            mainHeader.classList.remove('header-admin-mode');
                            mainContentArea.style.display = 'block';
                            document.querySelector('.search-bar').style.display = 'flex';
                        } else {
                            // Default: go back to admin dashboard
                            addPage.classList.remove('show');
                            addPage.style.display = 'none';
                            adminDashboard.classList.add('show');
                        }
                    }
                } catch (error) {
                    console.error('Add form error:', error);
                    alert('خطا در ارسال اطلاعات. لطفاً دوباره تلاش کنید.');
                } finally {
                    addSubmitBtn.disabled = false;
                    addSubmitBtn.innerHTML = '<span class="send-icon">↑</span>';
                }
            });
        }

        // Success checkmark animation function
        function showSuccessCheckmark() {
            // Remove any existing checkmark
            const existingCheckmark = document.querySelector('.success-checkmark');
            if (existingCheckmark) {
                existingCheckmark.remove();
            }
            
            // Create checkmark element
            const checkmark = document.createElement('div');
            checkmark.className = 'success-checkmark';
            checkmark.innerHTML = '<div class="success-checkmark-circle"><div class="success-checkmark-icon"></div></div>';
            
            // Add to page
            document.body.appendChild(checkmark);
            
            // Remove after animation completes (total animation time: ~0.8s)
            setTimeout(function() {
                checkmark.classList.add('success-checkmark-fadeout');
                setTimeout(function() {
                    if (checkmark.parentNode) {
                        checkmark.remove();
                    }
                }, 300);
            }, 800);
        }

        // Add page back button handler
        if (addPageBackBtn) {
            addPageBackBtn.addEventListener('click', function() {
                addPage.classList.remove('show');
                addPage.style.display = 'none';
                adminDashboard.classList.add('show');
                backBtn.style.display = 'none';
            });
        }

        // Delete/Edit page back button handler
        if (deleteEditPageBackBtn) {
            deleteEditPageBackBtn.addEventListener('click', function() {
                // Reset state
                if (deleteEditResults) {
                    deleteEditResults.style.display = 'none';
                    deleteEditResults.innerHTML = '';
                }
                if (deleteEditActions) {
                    deleteEditActions.style.display = 'none';
                }
                if (deleteEditInput) {
                    deleteEditInput.value = '';
                }
                selectedImageData = null;
                
                deleteEditPage.classList.remove('show');
                deleteEditPage.style.display = 'none';
                adminDashboard.classList.add('show');
                backBtn.style.display = 'none';
            });
        }

        // Delete/Edit form submission
        let selectedImageData = null;

        function displayDeleteEditResults(data) {
            deleteEditResults.innerHTML = '';
            deleteEditResults.style.display = 'block';
            selectedImageData = null;
            deleteEditActions.style.display = 'none';
            deleteActionBtn.disabled = true;
            editActionBtn.disabled = true;

            // Parse response - handle different response formats
            let images = [];
            
            if (Array.isArray(data)) {
                images = data;
            } else if (data.images && Array.isArray(data.images)) {
                images = data.images;
            } else if (data.items && Array.isArray(data.items)) {
                images = data.items;
            } else if (data.results && Array.isArray(data.results)) {
                images = data.results;
            } else if (data.url || data.image) {
                // Single image
                images = [{
                    url: data.url || data.image || data.image_url || data.photo,
                    caption: data.caption || data.description || data.text || ''
                }];
            } else if (typeof data === 'object') {
                // Try to extract image from object
                const url = data.url || data.image || data.image_url || data.photo;
                if (url) {
                    images = [{
                        url: url,
                        caption: data.caption || data.description || data.text || data.info || ''
                    }];
                }
            }

            if (images.length === 0) {
                deleteEditResults.innerHTML = '<div class="delete-edit-empty">نتیجه‌ای یافت نشد</div>';
                return;
            }

            images.forEach((imageData, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'delete-edit-image-item';
                imageItem.dataset.index = index;
                
                const img = document.createElement('img');
                img.src = imageData.url || imageData.image || imageData.image_url || imageData.photo;
                img.alt = imageData.caption || imageData.description || imageData.text || '';
                img.onerror = function() {
                    this.style.display = 'none';
                };
                
                const caption = document.createElement('div');
                caption.className = 'delete-edit-image-caption';
                caption.textContent = imageData.caption || imageData.description || imageData.text || imageData.info || '';
                
                imageItem.appendChild(img);
                imageItem.appendChild(caption);
                
                imageItem.addEventListener('click', function() {
                    // Remove previous selection
                    document.querySelectorAll('.delete-edit-image-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    // Add selection to clicked item
                    this.classList.add('selected');
                    selectedImageData = {
                        url: imageData.url || imageData.image || imageData.image_url || imageData.photo,
                        caption: imageData.caption || imageData.description || imageData.text || imageData.info || '',
                        index: index,
                        originalData: imageData
                    };
                    
                    // Enable action buttons
                    deleteActionBtn.disabled = false;
                    editActionBtn.disabled = false;
                    deleteEditActions.style.display = 'flex';
                });
                
                deleteEditResults.appendChild(imageItem);
            });

            // Scroll to results
            deleteEditResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        if (deleteEditForm) {
            deleteEditForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!requireAuth()) return;
                
                const inputValue = deleteEditInput.value.trim();

                if (!inputValue) {
                    alert('لطفاً کد طلا یا توضیحات محصول را وارد کنید');
                    return;
                }

                deleteEditSubmitBtn.disabled = true;
                deleteEditSubmitBtn.innerHTML = '<span class="send-icon">⏳</span>';
                deleteEditResults.style.display = 'block';
                const progressIndicator = createMicroProgressIndicator();
                deleteEditResults.innerHTML = '';
                deleteEditResults.appendChild(progressIndicator);
                deleteEditActions.style.display = 'none';

                try {
                    const token = getToken();
                    const username = getUsername();
                    
                    if (!token) {
                        alert('لطفاً ابتدا وارد شوید');
                        deleteEditSubmitBtn.disabled = false;
                        deleteEditSubmitBtn.innerHTML = '<span class="send-icon">↑</span>';
                        return;
                    }
                    
                    const response = await fetch(ADMIN_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'delete_edit_search',
                            token: token,
                            username: username,
                            searchQuery: inputValue,
                            timestamp: new Date().toISOString()
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        if (errorData.message && (errorData.message.includes('token') || errorData.message.includes('unauthorized'))) {
                            clearToken();
                            requireAuth();
                            return;
                        }
                        throw new Error(errorData.message || 'خطا در ارسال اطلاعات');
                    }

                    const data = await response.json();
                    
                    // Show message from backend if available
                    const message = data.message || '';
                    if (message) {
                        alert(message);
                    }
                    
                    // Check for nextpage in response
                    const nextpage = data.nextpage || data.nextPage || '';
                    if (nextpage) {
                        if (nextpage === 'login') {
                            clearToken();
                            requireAuth();
                            deleteEditPage.classList.remove('show');
                            deleteEditPage.style.display = 'none';
                        } else if (nextpage === 'Home' || nextpage === 'home') {
                            deleteEditPage.classList.remove('show');
                            deleteEditPage.style.display = 'none';
                            adminDashboard.classList.remove('show');
                            mainHeader.classList.remove('header-admin-mode');
                            mainContentArea.style.display = 'block';
                            document.querySelector('.search-bar').style.display = 'flex';
                        } else if (nextpage === 'admin/delete_edit_search') {
                            // Stay on delete/edit page - display results
                    displayDeleteEditResults(data);
                        } else {
                            // Default: go back to admin dashboard
                            deleteEditPage.classList.remove('show');
                            deleteEditPage.style.display = 'none';
                            adminDashboard.classList.add('show');
                        }
                    } else {
                        // No nextPage - display results normally
                        displayDeleteEditResults(data);
                    }
                    
                } catch (error) {
                    console.error('Delete/Edit form error:', error);
                    deleteEditResults.innerHTML = '<div class="delete-edit-empty" style="color: #ff3b30;">خطا در دریافت اطلاعات. لطفاً دوباره تلاش کنید.</div>';
                    alert('خطا در ارسال اطلاعات. لطفاً دوباره تلاش کنید.');
                } finally {
                    deleteEditSubmitBtn.disabled = false;
                    deleteEditSubmitBtn.innerHTML = '<span class="send-icon">↑</span>';
                }
            });
        }

        // Delete action button
        if (deleteActionBtn) {
            deleteActionBtn.addEventListener('click', async function() {
                if (!selectedImageData || !requireAuth()) {
                    alert('لطفاً ابتدا یک تصویر را انتخاب کنید');
                    return;
                }

                deleteActionBtn.disabled = true;
                editActionBtn.disabled = true;
                deleteActionBtn.textContent = 'در حال حذف...';

                try {
                    const token = getToken();
                    const username = getUsername();
                    
                    if (!token) {
                        alert('لطفاً ابتدا وارد شوید');
                        return;
                    }
                    
                    const response = await fetch(ADMIN_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'delete',
                            token: token,
                            username: username,
                            imageUrl: selectedImageData.url,
                            caption: selectedImageData.caption,
                            imageData: selectedImageData.originalData,
                            timestamp: new Date().toISOString()
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        if (errorData.message && (errorData.message.includes('token') || errorData.message.includes('unauthorized'))) {
                            clearToken();
                            requireAuth();
                            return;
                        }
                        throw new Error(errorData.message || 'خطا در حذف');
                    }

                    const data = await response.json();
                    alert('عملیات حذف با موفقیت انجام شد');
                    
                    // Clear results and reset form
                    deleteEditResults.style.display = 'none';
                    deleteEditResults.innerHTML = '';
                    deleteEditActions.style.display = 'none';
                    deleteEditInput.value = '';
                    selectedImageData = null;
                    
                } catch (error) {
                    console.error('Delete action error:', error);
                    alert('خطا در حذف. لطفاً دوباره تلاش کنید.');
                } finally {
                    deleteActionBtn.disabled = false;
                    editActionBtn.disabled = false;
                    deleteActionBtn.textContent = 'حذف';
                }
            });
        }

        // Edit action button
        if (editActionBtn) {
            editActionBtn.addEventListener('click', async function() {
                if (!selectedImageData || !requireAuth()) {
                    alert('لطفاً ابتدا یک تصویر را انتخاب کنید');
                    return;
                }

                editActionBtn.disabled = true;
                deleteActionBtn.disabled = true;
                editActionBtn.textContent = 'در حال ادیت...';

                try {
                    const token = getToken();
                    const username = getUsername();
                    
                    if (!token) {
                        alert('لطفاً ابتدا وارد شوید');
                        return;
                    }
                    
                    const response = await fetch(ADMIN_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'edit',
                            token: token,
                            username: username,
                            imageUrl: selectedImageData.url,
                            caption: selectedImageData.caption,
                            imageData: selectedImageData.originalData,
                            timestamp: new Date().toISOString()
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        if (errorData.message && (errorData.message.includes('token') || errorData.message.includes('unauthorized'))) {
                            clearToken();
                            requireAuth();
                            return;
                        }
                        throw new Error(errorData.message || 'خطا در ادیت');
                    }

                    const data = await response.json();
                    const nextpage = data.nextpage || data.nextPage || '';
                    
                    if (nextpage === 'admin/add') {
                        // Navigate to add page and fill the form
                        deleteEditPage.classList.remove('show');
                        deleteEditPage.style.display = 'none';
                        addPage.classList.add('show');
                        addPage.style.display = 'block';
                        backBtn.style.display = 'flex';
                        
                        // Fill the form with data from response
                        const goldCodeInput = document.getElementById('goldCode');
                        const productDescriptionInput = document.getElementById('productDescription');
                        
                        if (goldCodeInput && data.code) {
                            goldCodeInput.value = data.code;
                        }
                        if (productDescriptionInput && data.text) {
                            productDescriptionInput.value = data.text;
                        }
                        
                        // Fill the image if provided - convert URL to File and set in input
                        if (data.image || data.image_url || data.url || data.photo || selectedImageData?.url) {
                            const imageUrl = data.image || data.image_url || data.url || data.photo || selectedImageData.url;
                            
                            // Show image in preview immediately
                            if (imagePreview) {
                                const img = document.createElement('img');
                                img.src = imageUrl;
                                img.alt = 'Preview';
                                imagePreview.innerHTML = '';
                                imagePreview.appendChild(img);
                            }
                            
                            // Fetch the image and convert to File for the input
                            try {
                                const imageResponse = await fetch(imageUrl);
                                const imageBlob = await imageResponse.blob();
                                
                                // Get file extension from URL or default to jpg
                                const urlParts = imageUrl.split('.');
                                const extension = urlParts.length > 1 ? urlParts[urlParts.length - 1].split('?')[0] : 'jpg';
                                const mimeType = imageBlob.type || `image/${extension === 'png' ? 'png' : 'jpeg'}`;
                                
                                // Create File object
                                const fileName = `edit-image.${extension}`;
                                const imageFile = new File([imageBlob], fileName, { type: mimeType });
                                
                                // Set file in input using DataTransfer
                                const dataTransfer = new DataTransfer();
                                dataTransfer.items.add(imageFile);
                                if (imageInput) {
                                    imageInput.files = dataTransfer.files;
                                }
                            } catch (error) {
                                console.error('Error loading image for edit:', error);
                                // Image preview is already shown, so user can still see it
                            }
                        }
                    } else if (nextpage === 'home' || nextpage === 'Home') {
                        // Go back to home
                        deleteEditPage.classList.remove('show');
                        deleteEditPage.style.display = 'none';
                        adminDashboard.classList.remove('show');
                        mainHeader.classList.remove('header-admin-mode');
                        mainContentArea.style.display = 'block';
                        document.querySelector('.search-bar').style.display = 'flex';
                        backBtn.style.display = 'none';
                    } else {
                        // Default: show success message and clear form
                        alert('عملیات ادیت با موفقیت انجام شد');
                        
                        // Clear results and reset form
                        deleteEditResults.style.display = 'none';
                        deleteEditResults.innerHTML = '';
                        deleteEditActions.style.display = 'none';
                        deleteEditInput.value = '';
                        selectedImageData = null;
                    }
                    
                } catch (error) {
                    console.error('Edit action error:', error);
                    alert('خطا در ادیت. لطفاً دوباره تلاش کنید.');
                } finally {
                    editActionBtn.disabled = false;
                    deleteActionBtn.disabled = false;
                    editActionBtn.textContent = 'ادیت';
                }
            });
        }
    </script>
</body>
</html>
